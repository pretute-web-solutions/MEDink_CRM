
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>




    <style>
/* ðŸŒ GLOBAL STYLE */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
}
/* ðŸ”¹ HISTORY TOOLTIP */
.history-tooltip {
    position: relative;
    max-width: 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
}
/* popup box */
.history-tooltip .history-popup {
    display: none;

    position: fixed;   /* ðŸ”¥ FIXED â€“ not absolute */

    background: #1f2937;
    color: #fff;
    padding: 10px 12px;
    border-radius: 8px;

    min-width: 280px;
    max-width: 420px;
    max-height: 220px;

    font-size: 12px;
    line-height: 1.4;

    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    z-index: 999999;   /* ðŸ”¥ above everything */

    white-space: normal;
    word-break: break-word;
    overflow-y: auto;
}


/* arrow */
.history-tooltip .history-popup::before {
    content: "";
    position: absolute;
    top: -6px;
    left: 18px;
    border-width: 6px;
    border-style: solid;
    border-color: transparent transparent #1f2937 transparent;
}

/* show on hover */
.history-tooltip:hover .history-popup {
    display: block;
}

/* Cropper internal background fix */
.cropper-container,
.cropper-canvas,
.cropper-wrap-box,
.cropper-drag-box {
    background-color: #000 !important;
}

/* ðŸ§­ TOP NAVBAR */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: auto;
    min-width: 100%;
    height: 60px;
    background-color: #d6eefe;
    color: #0d47a1;
    display: flex;
    align-items: center;
    padding: 0 20px;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    justify-content: space-between;
    overflow: visible;
}

.top-navbar img {
    border-radius: 50%;
}

.top-navbar span {
    font-weight: bold;
    margin-left: 15px;
    font-size: 1.1rem;
}

/* ðŸ”¹ PROFILE ICON */
.profile-container {
    position: relative;
    margin-left: auto;
    margin-right: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
    min-width: 60px;
}

.profile-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #1e88e5);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 18px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    border: 2px solid white;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}

.profile-icon:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.5);
}

.profile-dropdown {
    position: absolute;
    top: 50px;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    min-width: 200px;
    display: none;
    z-index: 1001;
    overflow: hidden;
}

.profile-dropdown.show {
    display: block;
}

.profile-dropdown-header {
    padding: 15px;
    background: linear-gradient(90deg, #007bff, #1e88e5);
    color: white;
    border-bottom: 1px solid #e0e0e0;
}

.profile-dropdown-header strong {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
}

.profile-dropdown-header small {
    font-size: 12px;
    opacity: 0.9;
}

.profile-dropdown-menu {
    list-style: none;
    padding: 8px 0;
    margin: 0;
}

.profile-dropdown-menu li {
    padding: 0;
}

.profile-dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    color: #333;
    text-decoration: none;
    font-size: 14px;
    transition: background 0.2s;
}

.profile-dropdown-menu a:hover {
    background: #f5f5f5;
}

.profile-dropdown-menu a i {
    width: 20px;
    color: #007bff;
}

.profile-dropdown-menu a.logout-link {
    color: #dc3545;
    border-top: 1px solid #e0e0e0;
}

.profile-dropdown-menu a.logout-link i {
    color: #dc3545;
}

.profile-dropdown-menu a.logout-link:hover {
    background: #ffebee;
}

/* Toggle Button */
.toggle-btn {
    position: fixed;
    top: 500px;
    left: 10px;
    background-color: rgb(190, 190, 193);
    color: black;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 5px;
    z-index: 1000;
    transition: left 0.3s;
}

/* ðŸ§­ SECOND NAVBAR (Filters) */
.nav2 {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding: 10px;
    margin-top: 60px;
    margin-left: 0px;
    transition: margin-left 0.3s ease;
    background-color: white;
    border-bottom: 1px solid #cfd8dc;
    color: #0d47a1;
}

.nav2 button,
.nav2 a {
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.nav2 button.active-filter {
    background-color: #007bff;
    color: white;
}

.nav2 .date-filter {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ðŸ“‹ TABLE SECTION */
.nav3 {
    margin-left: 0px;
    overflow-x: auto;
    background-color: white;
    transition: margin-left 0.3s ease;
}

/* Ensure nav3 doesn't overlap footer on mobile */
@media (max-width: 768px) {
    .nav3 {
        margin-bottom: 50px;
    }
}

.nav3 table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.nav3 th,
.nav3 td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.nav3 th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* ðŸŸ¢ STATUS COLORS */
.status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.status.unread { background-color: #ffebee; color: red; }
.status.draft { background-color: #fff3e0; color: orange; }
.status.final { background-color: #e8f5e9; color: green; }

.green-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: green;
    border-radius: 50%;
}

/* ðŸ“± RESPONSIVE DESIGN */

/* ========== TABLET (768px - 992px) ========== */
@media (max-width: 992px) and (min-width: 769px) {
    .top-navbar span {
        font-size: 1rem;
        margin-left: 10px;
    }
    
    .top-navbar span[style*="margin-left: 900px"] {
        margin-left: auto !important;
    }

    .nav2 {
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
    }

    .nav3 {
        margin-left: 0px;
        width: 100%;
    }

    .nav3 table {
        font-size: 12px;
    }

    .nav3 th,
    .nav3 td {
        padding: 7px;
    }

    .modal {
        width: 90%;
        max-width: 600px;
    }

    .date-chip-box {
        flex-wrap: wrap;
    }
}

/* ========== MOBILE (481px - 768px) ========== */
@media (max-width: 768px) and (min-width: 481px) {
    .top-navbar {
        padding: 0 10px;
        height: 50px;
    }

    .top-navbar img {
        height: 35px;
    }

    .top-navbar span {
        font-size: 0.9rem;
        margin-left: 8px;
    }

    .top-navbar span[style*="margin-left: 900px"] {
        margin-left: auto !important;
        font-size: 12px !important;
    }

    .profile-container {
        gap: 8px;
        margin-right: 5px;
    }

    .profile-container span {
        display: none;
    }

    .profile-icon {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }

    .profile-dropdown {
        right: 10px;
        min-width: 180px;
    }

    .nav2 {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        padding: 12px;
        margin-top: 50px;
    }

    .nav2 > * {
        width: 100%;
    }

    .add-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
    }

    #statusFilter {
        width: 100%;
        padding: 8px;
        text-align: center;
    }

    .date-chip-box {
        width: 100%;
        flex-wrap: wrap;
        justify-content: center;
        padding: 6px;
    }

    .chip {
        padding: 4px 8px;
        font-size: 11px;
    }

    #dayChip {
        width: auto;
        padding: 4px 8px !important;
    }

    .nav3 {
        margin-left: 0;
        top: auto;
        position: relative;
        margin-top: 0;
    }

    .nav3 table {
        font-size: 11px;
        min-width: 800px;
    }

    .nav3 th,
    .nav3 td {
        padding: 6px 4px;
    }

    .modal {
        width: 95%;
        max-width: 500px;
        height: auto;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        height: 45px;
    }

    .modal-header h2 {
        font-size: 16px;
    }

    .patient-form {
        padding: 12px;
    }

    .row {
        flex-direction: column;
        gap: 10px;
    }

    .field {
        width: 100%;
    }

    .field input,
    .field select {
        width: 100% !important;
    }

    .field input[style*="width:158%"],
    .field input[style*="width: 50%"],
    .field input[style*="width: 87%"],
    .field input[style*="width: 165%"],
    .field input[style*="width: 92%"],
    .field select[style*="width: 70%"] {
        width: 100% !important;
    }

    .gender-box {
        margin-left: 0 !important;
        width: 100%;
    }

    .gender {
        max-width: 100%;
    }

    .bottom-row {
        flex-direction: column;
        gap: 10px;
    }

    .upload-box {
        width: 100%;
        text-align: center;
        margin-right: 0 !important;
        margin-bottom: 0 !important;
    }

    .submit-btn {
        width: 100%;
        margin-bottom: 0 !important;
    }

    #footerPagination {
        padding: 0 10px;
        font-size: 11px;
        height: 40px;
    }

    #footerPagination button {
        padding: 4px 6px;
        font-size: 11px;
    }

    #footerPagination select {
        padding: 3px 5px;
        font-size: 11px;
    }

    .toggle-btn {
        display: none;
    }
}

/* ========== MOBILE SMALL (up to 480px) ========== */
@media (max-width: 480px) {
    .top-navbar {
        justify-content: space-between;
        padding: 0 8px;
        height: 50px;
    }

    .top-navbar img {
        height: 30px;
    }

    .top-navbar span:first-of-type {
        font-size: 0.85rem;
        margin-left: 6px;
    }

    .top-navbar span[style*="margin-left: 900px"] {
        display: none !important;
    }

    .top-navbar a[href*="logout"] {
        margin-left: auto;
    }

    .profile-container {
        margin-right: 5px;
    }

    .profile-container span {
        display: none !important;
    }

    .profile-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
    }

    .profile-dropdown {
        right: 8px;
        min-width: 160px;
        font-size: 13px;
    }

    .profile-dropdown-menu a {
        padding: 10px 12px;
        font-size: 13px;
    }

    .nav2 {
        padding: 10px 8px;
        margin-top: 50px;
        gap: 8px;
    }

    .add-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        border-radius: 6px;
    }

    #statusFilter {
        width: 100%;
        padding: 8px 6px;
        font-size: 11px;
        display: flex;
        justify-content: space-around;
        align-items: center;
    }

    #statusFilter span {
        padding: 6px 8px;
        font-size: 11px;
    }

    .date-chip-box {
        width: 100%;
        padding: 6px 4px;
        font-size: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .chip {
        padding: 4px 6px;
        font-size: 10px;
    }

    .calendar-icon {
        padding: 4px;
    }

    #dayChip {
        width: auto;
        padding: 4px 8px !important;
        font-size: 10px;
    }

    .nav3 {
        margin-left: 0;
        margin-top: 0;
        position: relative;
        padding: 4px;
    }

    .nav3 table {
        font-size: 10px;
        min-width: 700px;
    }

    .nav3 th,
    .nav3 td {
        padding: 5px 3px;
        font-size: 10px;
    }

    .nav3 th {
        font-size: 10px;
        padding: 6px 4px;
    }

    /* Hide less important columns on mobile */
    th:nth-child(6), td:nth-child(6),
    th:nth-child(9), td:nth-child(9) {
        display: none;
    }

    td strong {
        font-size: 11px;
        display: block;
    }

    td small {
        font-size: 9px;
    }

    .status {
        font-size: 10px;
        padding: 2px 6px;
    }

    .modal {
        width: 98%;
        max-width: 100%;
        margin: 10px auto;
        height: auto;
        max-height: 95vh;
        overflow-y: auto;
        border-radius: 10px;
    }

    .modal-header {
        height: 40px;
        padding: 0 10px;
    }

    .modal-header h2 {
        font-size: 14px;
    }

    .modal-header span[onclick*="closePatientPopup"] {
        right: 8px !important;
        top: 4px !important;
        font-size: 20px !important;
    }

    .patient-form {
        padding: 10px;
    }

    .row {
        flex-direction: column;
        gap: 8px;
        margin-bottom: 10px;
    }

    .field {
        width: 100%;
    }

    .field label {
        font-size: 12px;
        margin-bottom: 3px;
    }

    .field input,
    .field select {
        width: 100% !important;
        padding: 8px 10px;
        font-size: 14px;
    }

    .field input[style*="width:158%"],
    .field input[style*="width: 50%"],
    .field input[style*="width: 87%"],
    .field input[style*="width: 165%"],
    .field input[style*="width: 92%"],
    .field select[style*="width: 70%"] {
        width: 100% !important;
    }

    .field[style*="margin-left: 110px"],
    .field[style*="margin-left: -50px"],
    .field[style*="margin-right: 120px"],
    .field[style*="margin-right: 0px"] {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    .gender {
        max-width: 100%;
        width: 100%;
    }

    .gender-box {
        margin-left: 0 !important;
        width: 100%;
        height: 40px;
    }

    .gender-box span {
        line-height: 40px;
    }

    .bottom-row {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }

    .upload-box {
        width: 100%;
        padding: 12px;
        text-align: center;
        margin-right: 0 !important;
        margin-bottom: 0 !important;
        font-size: 13px;
    }

    .submit-btn {
        width: 100%;
        padding: 14px;
        font-size: 14px;
        margin-bottom: 0 !important;
        margin-top: 0;
    }

    #selectedImagesPreview {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 8px;
    }

    #imagesList {
        gap: 6px;
    }

    #imagesList > div {
        width: 70px !important;
        height: 70px !important;
    }

    #cropEditor > div {
        width: 95%;
        padding: 12px;
    }

    #cropEditor > div > div:first-child {
        height: 60vh;
    }

    #footerPagination {
        padding: 0 8px;
        font-size: 10px;
        height: 40px;
        flex-wrap: wrap;
    }

    .footer-center {
        gap: 4px;
    }

    #footerPagination button {
        padding: 4px 6px;
        font-size: 10px;
    }

    #footerPagination select {
        padding: 3px 5px;
        font-size: 10px;
    }

    #pageSummary,
    #displaySummary {
        font-size: 10px;
    }

    .toggle-btn {
        display: none;
    }

    .history-tooltip .history-popup {
        min-width: 200px;
        max-width: 280px;
        font-size: 11px;
        padding: 8px 10px;
    }

    /* Search input styling */
    #searchInput {
        width: 100% !important;
        padding: 10px 35px 10px 12px !important;
        font-size: 13px;
        border-radius: 6px;
        border: 1px solid #ddd;
    }

    /* Scan type filter button */
    .nav2 button[style*="padding: 6px"] {
        width: 100%;
        padding: 10px !important;
        font-size: 12px;
    }

    .scan-option {
        font-size: 11px;
        padding: 4px 6px;
    }
}

/* ========== Additional responsive fixes ========== */
@media (max-width: 768px) {
    body {
        padding-bottom: 60px;
    }

    /* Patient popup overlay adjustments */
    #patientPopupOverlay {
        padding: 10px;
    }

    /* Search input wrapper */
    #searchInput {
        width: 100% !important;
        padding: 10px 35px 10px 12px !important;
        font-size: 13px;
        border-radius: 6px;
        margin-bottom: 0;
    }

    /* Make scan type filter responsive */
    .nav2 button[style*="padding: 6px"] {
        width: 100%;
        padding: 10px !important;
        font-size: 12px;
    }
}

/* TABLE SCROLL & STICKY HEADER */


#nav3 thead th {
    position: sticky;
    top: 0;
    background-color: rgb(230, 228, 228);
    z-index: 10;
    border-bottom: 2px solid #ccc;
}

/* ROW COLORS */
tr {
    background-color: #f7fbff !important;
}

tr:hover {
    background-color: #eef6ff !important;
}

tr.status-final { background-color: #f2fbf2 !important; }
tr.status-unread { background-color: #fff4f4 !important; }
tr.status-draft { background-color: #fef9e7 !important; }

.status-option.active {
    font-weight: 700 !important;
    color:  #007bff !important;
}

.scan-option {
    color: black !important;
    font-weight: 400 !important;
    cursor: pointer;
    padding: 0 6px;
}

.scan-option.active {
    color: #007bff !important;
    font-weight: 700 !important;
}


#nav3 {
    position: fixed;
    top: 110px;     /* nav2 height (approx 95px) */
    left: 0;
    right: 0;
    bottom: 50px;   /* footer height */
    overflow-y: auto;
    overflow-x: auto;
    background: white;
    padding: 0 5px;
}


.add-btn {
    background: #007bff;  
    width: 100px;         /* blue */
    color: white;
    
    padding: 10px 18px;
    border: none;
    border-radius: 8px;            /* smooth rounded */
    font-size: 15px;
    display: inline-flex;
    align-items: center;
    gap: 6px;                      /* icon gap */
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    transition: 0.25s ease-in-out; /* smooth animation */
}

.add-btn:hover {
    background: #0056d2;           /* darker blue on hover */
    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.45);
    transform: translateY(-2px);   /* small lift effect */
}

.add-btn:active {
    transform: scale(0.96);        /* click animation */
}

/* Date range */
.date-chip-box {
    display: flex;
    align-items: center;
    /* gap: 8px; */
    background: #ffffff;
    border: 1px solid rgb(217, 217, 217);
    /* padding: 8px 10px; */
    border-radius: 5px;
    font-size: 12px;
    font-weight: 500;
}

.chip {
    cursor: pointer;
    padding: 0 6px;
    color: #1f1f20;
    font-weight: 500;
}

.chip.active {
    color: #007bff;
    font-weight: 500;
    
}

.divider {
    color: #b0b0b0;
}

.calendar-icon {
    padding: 4px 6px;
    cursor: pointer;
    background: #ffffff;
    border-radius: 6px;
    /* border: 1px solid #c9dfff; */
}

.calendar-icon i {
    color: #007bff;
    font-size: 14px;
}
#dayChip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 60px;       /* FIXED WIDTH */
    height: 26px;
    padding: 0 !important;
    text-align: center;
}
#refreshTimer {
  font-size: 14px;
  color: #007bff;
}

/* ===== FOOTER PAGINATION ===== */
#footerPagination {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 45px;
    background: #ffffff;
    border-top: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 9999;
    font-size: 13px;
}

.footer-center {
    display: flex;
    align-items: center;
    gap: 8px;
}

#pageSummary,
#displaySummary {
    font-size: 12px;
    color: #6b7280;
}

#footerPagination select {
    padding: 4px 6px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

#footerPagination button {
    padding: 4px 8px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 5px;
    cursor: pointer;
}

#pageNumber {
    background: #007bff;
    color: #fff;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
}


.modal {
  width: 570px;
  background: #fff;
  margin: 40px auto;
  border-radius: 14px;
  height: auto;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

/* Responsive modal */
@media (max-width: 768px) {
    .modal {
        width: 95%;
        max-width: 500px;
        margin: 20px auto;
    }
}

@media (max-width: 480px) {
    .modal {
        width: 98%;
        max-width: 100%;
        margin: 10px auto;
        max-height: 95vh;
    }
}
/* Chrome, Edge, Safari */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Firefox */
input[type=number] {
    -moz-appearance: textfield;
}

.modal-header {
  background: linear-gradient(90deg, #007bff , #1e88e5);
  /* padding: 14px; */
  text-align: center;
  height: 30px;
}

.modal-header h2 {
  color: #fff;
  margin: 0;
  font-weight: 500;
  font-size: 18px;
}

.patient-form {
  padding: 16px ;
}

.row {
  display: flex;
  gap: 14px;
  margin-bottom: 14px;
}

.field {
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-top: auto;
}

.field label {
  font-size: 13px;
  margin-bottom: 4px;
  color: #555;
}

.field input,
.field select {
  /* height: 20px; */
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #d0d7e2;
  font-size: 13px;
  transition: all 0.3s ease;
}

.field input:focus,
.field select:focus {
  border-color: #1e88e5;
  box-shadow: 0 0 0 2px rgba(30,136,229,0.15);
  outline: none;
}

.gender {
  max-width: 100px;
}

.gender-box {
  display: flex;
  background: #f1f4f9;
  border-radius: 10px;
  overflow: hidden;
  height: 35px;
  margin-top: auto;
  margin-left: -30px;
}

.gender-box span {
  flex: 1;
  text-align: center;
  line-height: 40px;
  cursor: pointer;
  font-weight: 500;
  color: #555;
}

.gender-box span.active {
  background: #007bff ;
  color: #fff;
}

.bottom-row {
  align-items: center;
  justify-content: space-between;
}

.upload-box {
  background: #f1f4f9;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  color: #1e88e5;
  border: 1px dashed #1e88e5;
}

.upload-box:hover {
  background: #e3f2fd;
}

.submit-btn {
  padding: 16px 30px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(90deg, #007bff , #1e88e5);
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.submit-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 15px rgba(30,136,229,0.4);
}

/* ===== PROFILE MODAL ===== */
#profileModalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100000;
}

.profile-modal {
    width: 700px;
    max-width: 95%;
    background: #fff;
    border-radius: 14px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    position: relative;
}

.profile-modal-header {
    background: linear-gradient(90deg, #007bff, #1e88e5);
    padding: 14px;
    text-align: center;
    height: 40px;
    position: relative;
}

.profile-modal-header h2 {
    color: #fff;
    margin: 0;
    font-weight: 500;
    font-size: 18px;
}

.profile-modal-close {
    position: absolute;
    right: 16px;
    top: 8px;
    color: white;
    font-size: 22px;
    cursor: pointer;
    line-height: 1;
}

.profile-modal-body {
    padding: 30px;
}

.profile-edit-btn {
    position: absolute;
    top: 20px;
    right: 50px;
    padding: 8px 18px;
    background: rgba(255,255,255,0.2);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.profile-edit-btn:hover {
    background: rgba(255,255,255,0.3);
}

.profile-header-section {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
}

.profile-avatar-wrapper {
    position: relative;
    margin-right: 20px;
    cursor: pointer;
}

.profile-avatar {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #007bff;
}

.profile-avatar-overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    text-align: center;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 12px;
    padding: 3px 0;
    border-radius: 0 0 50px 50px;
    display: none;
}

.profile-avatar-wrapper.editable .profile-avatar-overlay {
    display: block;
}

#profileImageInput {
    display: none;
}

.profile-info h2 {
    font-size: 22px;
    margin: 0 0 8px 0;
    color: #333;
}

.profile-info p {
    color: #666;
    font-size: 14px;
    margin: 0;
}

.profile-details {
    margin-top: 20px;
}

.profile-row {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    gap: 15px;
}

.profile-label {
    width: 200px;
    font-weight: 600;
    color: #555;
    flex-shrink: 0;
}

.profile-input {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.profile-input:disabled {
    background: #f5f5f5;
    border: none;
    color: #333;
}

.profile-submit-btn {
    margin-top: 25px;
    padding: 10px 25px;
    background: #16a34a;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: none;
    font-size: 14px;
}

.profile-submit-btn:hover {
    background: #15803d;
}

/* Responsive Profile Modal */
@media (max-width: 768px) {
    .profile-modal {
        width: 95%;
        max-height: 95vh;
    }

    .profile-modal-body {
        padding: 20px;
    }

    .profile-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .profile-label {
        width: 100%;
    }

    .profile-input {
        width: 100%;
    }

    .profile-header-section {
        flex-direction: column;
        text-align: center;
    }

    .profile-avatar-wrapper {
        margin-right: 0;
        margin-bottom: 15px;
    }
}

    </style>
</head>
<body>
<div class="top-navbar">
    <img height="40" style="border-radius: 30px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQMAAADCCAMAAAB6zFdcAAAAdVBMVEX///88bLQ3abNpi8MnYa91k8ba4vD09voiX64rY7DEz+To7fU5arNIdbkzZ7IwZbG8y+Pg5/LK1ehSe7t+msqoutp0k8b2+fxrjMOTqtKLpM+uv9zQ2utVfbycsdW2xeBhhcAbW62En8yNps+Zr9QAUqoQV6w5NsUUAAAHHUlEQVR4nO2c0ULyOgyAR6mug25DQVBRAfU/7/+IR0AURpMmpZlc5LuGbvvWZm2arSgURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVGUq+NjfgMxnzHbGj2CbaHMZ89vy5dS5PooDFsD4la8tnwDt4XTNJV1zWzyNx6GZgDimwWnqacWboqCN5V7nLAOmQfMwaB5Z7Q0dpcp2GFs+3EndrEAqIOBvc3VEhnfuOG93PXyz9xMyQ2NcnSD76O66Ujwks+I3D37QG3IZ1PwhbfTHvtCxIFvx7R2Lg2IZwd2w97iQmwUNzekZrIExFOMfRK+9gPRSOZInTJTQDylql+kL5928r4mtJIxIJ4c232ICygoN7B9i7cyyBoRj6imPUwdCZ3YRcPiZyWkYPuclB8PBAdmGGljbMUUfI2HzfIKHAxcZMbyKBEQjw7/eQUOvEebuJcJiL/Y5793MGjRk6ilAmJfEmgPdofM2d7kAuIPVnQ40ByYV7CBcSXeDb5wkoGROMGz4DnMG+AvpiLR0E5A8hFJdOBbIL8DBkQzvx/FmSyfbuqNbeJ9qSEu3uQcDFogwQoFRF/Rz7m8fzYO6k4/Ttd5LjgAebET7owPUECsyImHPbfvNhJYLGHOngbZgQ+llEpoJJBWWh2WBrcQn7MnQl/0hu7sHPo3bcXdZdlgI0JsNNAdBFJKL3BATDubxYdFukJszp4KI/lxnlLKERA73NZYUu6ya4XgJIC6HRwOiJdM62bwKtQyN76IcBx0Al0JhTB/2f16cNB4uLBhCFYi8PT+3kAB7NJxOwKDghXJuPOSocePJzggxnIuUeDJ58VNh+A5OH48TaGbtbn8Ob6CJFiJOQIzKe4mhz+CAbHNsS3wDLTOnX6SABxAZnz7/b+yhQKiyXJeQC/z8CI+nbADM4Pi3WE7HvzBb0+5iDtgNKTPPGDCDtwYuMKv0b5LKcEBcZ3pxN7Dkqs8ik8AHCxW0Exlv3Z6BRcKuXZKgR1MVlkIEcBBCV/lNqW0hAy1+TbHZsETCC5fLwR0cAsui9tFCeV9vMlXTnQf9Oyb/JtvoAM46jXvH9C6JuuE3gdFO0Z5EBHYQQnOWA00TPKu8MODQSAowg7gWRAIp4QrzjJ4/Db/LAlxwN5AyhyzX4IBQeDBgDkAJwFhfAuHq5RQGU5WpqaoEDAHzA1lJCAuU2YNi2Blh0BWEXXAKixAahkXaUvJ4JpBYMWAOmDtpyIB8TnNwWvQQf5JEu6AUWjUwJX+dzZta2AdOreUnYsIEQcTalj0FRwQ1ybNQbgf9O6AnGNBkhsTm7hFdB3xYNuPSQqQu7MYpG6T1cEj9e+geI5tCO/YwOUB28VFkoNFcGUmkFaNOlgYQlhEJi67hFCSg3AGwdAKqDlEHRRgNgX4fYddcE9yEF48N/lLk+IOimk0LFZwacD+wZLk4C24Qq/yVyYRHIDZlAPY42o/ppMcBKcHEltNBAdwNuXwa/i0vl/tSHFQhsegwC4LxQG4uboHCYjjzSDZwSo4FCS2XSkOItkU5M4cunOKg+AsUWTHkeQAzaYgxQaTQ3dOcADsu1LepuBCc4CUZWMB8bc9voNwN8icrttDc4BkUyxcbPD7rhvfAbCDESmhT4PoAHxvzTyCTR9lYNgOoOwNskJPh+ig+AS2FCycJTtqmu2gBvqdSCEK1UERPimk2GB0dCu5DobAjCTTxn73aFQH4WwKck7HzxKmg0doH0tgsVAwHASnrhbe9Dl5143nYAiWKMqU69IdBJYNSJ77NKhxzn08BRUYiYjIcRDIpiDFBqcPU4aDEfJSR4ZqrxAMB2U3m9LAr1p1Xv4lO1jMwAJNoQdjwXLQnbeA77YUZ5NrqoOVwaqVrdB7vxwHnWwKsrfWTX/QHIymWNU643sUTFgOTnaCsXfdurM8goNyWaMGON8lYcJycFKivIFXL2eri5iDcnTTxt4RzFbtdQbPwdHLjC1cB3C+ykRyrovx6G3d2mj22kmNBK6D34GOFRsENilriKaytiGk75v8ZQc/MB38XB/80md4s9pDRK9+h1wwKPgOvvs5ck4Cn4f5Ei/5OQyug+8/IBVyAl9D8I3od4LYDnapYmTGJvA1BGEFfAfbDBlWLJr/awhGWEGCg8J4vNggM81A7m3vPQkOVg4J0pPcX4Ro1+JfVExwUNRIUi+zA++Ev4WyJcUB1jfzOjASr2yckeIAI6sDu5YOBTuu2IERXCKccLUOvJv39ZXdK3Xg7bSf7wZuuUoH3tZ9xMIDV+jA2Nc+DVyfA9/ax/5GwZ6rcuBbV7/18jg84VoceNNUrv4QqLCIs97YAP+SHaz+C7UXwzm/fl/1/pHxb+5ugyS3V4bbizD+gy/NK4qiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKBfwPy/9ZUL+NldGAAAAAElFTkSuQmCC" alt="Profile">
    
    <!-- <span >HOSPITAL</span> -->
    {% if request.session.user_name %}
    <div class="profile-container">
       <span style="font-size: 13px;">Welcome, {{ request.session.user_name }}</span>
       <div class="profile-icon" onclick="toggleProfileDropdown()" id="profileIconContainer">
           <img id="profileIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0QzE0IDUuMSAxMy4xIDYgMTIgNkMxMC45IDYgMTAgNS4xIDEwIDRDMTAgMi45IDEwLjkgMiAxMiAyWk0yMSAxOVYyMEgzVjE5QzMgMTYuMzMgNS4zMyAxNCA4IDE0SDE2QzE4LjY3IDE0IDIxIDE2LjMzIDIxIDE5WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; object-position: center; display: none;">
           <i class="fas fa-user" id="defaultProfileIcon" style="display: block;"></i>
       </div>
       <div class="profile-dropdown" id="profileDropdown">
           <div class="profile-dropdown-header">
               <strong>{{ request.session.user_name }}</strong>
               <small>Logged in</small>
           </div>
           <ul class="profile-dropdown-menu">
               <li><a href="#" onclick="openProfileModal(); return false;"><i class="fas fa-user-circle"></i> My Profile</a></li>
               <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
               <li><a href="{% url 'logout' %}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
           </ul>
       </div>
    </div>
    {% endif %}

</div>
{% block body %}

<div id="nav2"  class="nav2">
    <!-- <button style="" class="add-btn" onclick="window.location.href='/popupform/'">
    <i class="fas fa-user-plus"></i> Add New
</button> -->
<button class="add-btn" onclick="openPatientPopup()"> <i class="fas fa-user-plus"></i>Add New</button>


<!-- ========================= ADD PATIENT POPUP ========================= -->

<!-- ===== POPUP OVERLAY ===== -->
<div id="patientPopupOverlay" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
">
<div class="modal">
  <div class="modal-header">
    <h2>Patient Details</h2>

    <!-- CLOSE BUTTON -->
    <span onclick="closePatientPopup()" style="
      position:absolute;
      right:16px;
      top:8px;
      color:white;
      font-size:22px;
      cursor:pointer;">Ã—</span>
  </div>

  <form class="patient-form" id="patientPopupForm">

    <div class="row">
      <div class="field">
        <label>Patient ID</label>
        <input id="pop_patientId"  type="text" placeholder="Enter ID">
      </div>
      <!-- <div class="field">
        <label>Patient ID</label>
        <input id="pop_patientId"  type="text" placeholder="Enter ID">
      </div> -->
    </div>

    <div class="row">
      <div class="field">
        <label>Patient Name</label>
        <input id="pop_patientName" required style="width:158% ;"  id="" type="text" placeholder="Full Name">
      </div>

      <div style="margin-left: 110px;" class="field">
        <label>Age</label>
        <input style="width: 50%;" required id="pop_age" inputmode="numeric"  type="number" placeholder="Age">
        
      </div>

      <div style="margin-right: 0px; " class="field gender">
        <label>Gender</label>
        <div style="border: 1px solid #d1d8e3;" class="gender-box">
        <span style="" class="gender-btn active" data-gender="M">M</span>
        <span class="gender-btn" data-gender="F">F</span>
        <span class="gender-btn" data-gender="O">O</span>

        <input type="hidden" id="pop_gender">

        </div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="Modality">Modality</label>
        <select required style="width: 70%;" id="pop_scanType">
            <option value="X-RAY" selected>X-RAY</option>
            <option value="CT">CT</option>
            <option value="MRI">MRI</option>
            <option value="MG">MG</option>
        </select>

      </div>

      <div style="margin-left: -50px;" class="field">
        <label>Body Part</label>
        <input style="width: 87%;" required id="pop_bodyPart" type="text" placeholder="e.g. Chest">
        
      </div>

      <div style="margin-right: 120px;" class="field">
        <label> Clinical History</label>
        <input style="width: 165%;" id="pop_history" type="text" placeholder="Short history">
      </div>
    </div>

    <div class="row bottom-row">
      <div class="field">
        <label>Referred By</label>
        <input style="width: 92%;" id="pop_refBy" type="text" placeholder="Doctor name">
      </div>
      <label style="margin-right: 50px; margin-bottom: -13px; padding:6px;" class="upload-box">
        <input type="file" id="pop_uploadScan" required hidden accept="image/*" multiple>
        â¬† Upload Scan (Multiple)
      </label>

      

      <button style="padding: 10px 28px; margin-bottom: -12px;" class="submit-btn">Submit</button>
    </div>
    
    <!-- Selected Images Preview -->
    <div id="selectedImagesPreview" style="display:none; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:8px; margin-left:20px; margin-right:20px;">
        <div style="font-weight:600; margin-bottom:8px; color:#333;">Selected Images (Click to crop):</div>
        <div id="imagesList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>
    
<img id="pop_preview" style="display:none;">
<img id="pop_finalImage" style="display:none;">
<input type="hidden" id="pop_center" value="{{ request.session.user_name }}">

  </form>
</div>
</div>
<!-- ===== FULLSCREEN CROP EDITOR ===== -->
<div id="cropEditor" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    z-index:100000;

    
    align-items:center;
    justify-content:center;
">
    <div style="
        width:90%;
        max-width:700px;
        background:#ffffff;
        border-radius:12px;
        padding:16px;
        box-shadow:0 20px 50px rgba(0,0,0,0.4);
        display:flex;
        flex-direction:column;
    ">

        <!-- IMAGE PREVIEW AREA -->
        <div style="
            height:70vh;
            background:#111;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
        ">
            <img id="cropImage" style="
                max-width:100%;
                max-height:100%;
                object-fit:contain;
            ">
        </div>

        <!-- ACTION BUTTONS -->
        <div style="
            display:flex;
            justify-content:center;
            gap:12px;
            margin-top:14px;
        ">
            <button onclick="closeCropper()" style="
                padding:8px 20px;
                border-radius:6px;
                border:1px solid #ccc;
                background:#f3f4f6;
                cursor:pointer;
                font-size:14px;
            ">
                Cancel
            </button>

            <button onclick="finishCrop()" style="
                padding:8px 22px;
                background:#28a745;
                color:white;
                border:none;
                border-radius:6px;
                font-size:14px;
                font-weight:600;
                cursor:pointer;
                box-shadow:0 4px 10px rgba(40,167,69,0.35);
            ">
                Done
            </button>
        </div>

    </div>
</div>

<!-- ===== PROFILE MODAL ===== -->
<div id="profileModalOverlay">
    <div class="profile-modal">
        <div class="profile-modal-header">
            <h2>User Profile</h2>
            <button class="profile-edit-btn" onclick="enableProfileEdit()" id="profileEditBtn">Edit</button>
            <span class="profile-modal-close" onclick="closeProfileModal()">Ã—</span>
        </div>

        <div class="profile-modal-body">
            <div class="profile-header-section">
                <div class="profile-avatar-wrapper" onclick="triggerProfileUpload()" id="profileAvatarWrapper">
                    <img src="https://via.placeholder.com/90" class="profile-avatar" id="profileAvatar">
                    <div class="profile-avatar-overlay">Edit</div>
                    <input type="file" id="profileImageInput" accept="image/*" onchange="handleProfilePictureChange(event)">
                </div>
                <div class="profile-info">
                    <h2 id="profileNameDisplay">{{ request.session.user_name }}</h2>
                    <p>Registered on: <span id="profileRegDate">10 Jan 2026</span></p>
                </div>
            </div>

            <form id="profileForm">
                <div class="profile-details">
                    <div class="profile-row">
                        <div class="profile-label">Full Name</div>
                        <input type="text" class="profile-input" id="profileFullName" placeholder="Enter your name" disabled>
                    </div>

                    <div class="profile-row">
                        <div class="profile-label">Username</div>
                        <input type="text" class="profile-input" id="profileUsername" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>

                    <div class="profile-row">
                        <div class="profile-label">Password</div>
                        <input type="password" class="profile-input" id="profilePassword" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>

                    <div class="profile-row">
                        <div class="profile-label">Email <span style="color: #999; font-size: 12px;">(Optional)</span></div>
                        <input type="email" class="profile-input" id="profileEmail" placeholder="Enter email address (optional)" disabled>
                    </div>

                    <div class="profile-row">
                        <div class="profile-label">Phone <span style="color: #999; font-size: 12px;">(Optional)</span></div>
                        <input type="text" class="profile-input" id="profilePhone" placeholder="Enter phone number (optional)" disabled>
                    </div>

                    <button type="submit" class="profile-submit-btn" id="profileSubmitBtn">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- <img id="pop_finalImage" style="display:none;"> -->

<div class="date-chip-box" style="box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);">

    <!-- <span class="chip active" style="color: #007bff;" onclick="setDateFilter('ALL')">All</span> -->
    <!-- <span class="divider">|</span> -->

    <span style="color:#007bff ; font-weight: bold;" class="chip" onclick="goPrevDay()">&lt;&lt;</span>

    <span id="dayChip" class="chip active" onclick="setDateFilter('TODAY')">TODAY</span>


    <span style="color:#007bff; font-weight: bold;" class="chip" onclick="goNextDay()">&gt;&gt;</span>

    <!-- <span class="divider">|</span> -->
    <span class="chip" onclick="setDateFilter('MONTH')">MONTH</span>

    <span class="calendar-icon" onclick="openDateRange()">
        <i class="fa-regular fa-calendar"></i>
    </span>
</div>

<div id="statusFilter" style="padding: 6px; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); gap background-color: white; border-radius: 5px; font-size:12px; font-weight: 500; margin-left: 0px; border: 1px solid #ccc; margin-top: 0px; ">
    <span id="filter-all" class="status-option" style="cursor:pointer; padding: 0 6px;" onclick="filterPatients('ALL')">All</span><span style="color: black;"> |</span>
    <span id="filter-final" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('FINAL')">FINAL</span><span style="color: black;"> |</span>
    <span id="filter-unread" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('UNREAD')">UNREAD</span>

</div>
     <button style="padding: 6px; background-color: white; font-size:12px;box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); font-weight: 500;border: 1px solid #ccc; margin-left: 0px; margin-top: 0px;">
       <span class="scan-option" style=" " onclick="filterByScanType('ALL')">All</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('X-RAY')">X-RAY</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('CT')">CT</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MRI')">MRI</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MG')">MG</span>
    </button>

 <div style=" display: inline-block; margin-left: 4px;box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); position: relative;">
  <input type="search" id="searchInput" placeholder="search scan..."
    style="margin-left: 0px;border: 1px solid #ccc; color: rgb(232, 230, 230); padding: 3px 35px 5px 10px; border-radius: 5px; font-weight: 400;  width: 150px; font-size: 14px;">

</div>
    <a href="" style="background-color: rgb(251, 250, 250);box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); border: 1px solid #ccc; color: #007bff;">
        <i class="fa-solid fa-search"></i>
    </a>
    <a href="" style="background-color: rgb(251, 250, 250);box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); border: 1px solid #ccc; color: #007bff;">
        <i class="fa-solid fa-rotate-right"></i>
    </a>
    <div style="margin-top: 10px;">
     <span id="refreshTimer" style="margin-left: 0px; font-size: 10px; font-weight: 500; color: white;">
    <span id="live-seconds" style=" color:white;">30s</span>
    </div>

<div id="calendarContainer" style="display:none; margin-left: -700px; margin-top:15px; position:relative;">
    <div id="calendarBox" style="position:absolute; z-index:9999; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
        
        <input type="text" id="calendarInput" readonly 
               style="width:240px; padding:8px; border:1px solid #ccc; border-radius:6px; display: none;">

        <div id="litepickerInline" style="margin-top:8px;"></div>
    </div>
</div>
</div>   <!-- Close nav2 properly -->

<div id="nav3" class="nav3">
    <table >
        <thead>
            <tr>
                 <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">Date</th>
                <th>Patient</th>
                <th>Age/Sex</th>
                <th>Scan Type</th>
                <th>Body Part</th>
                <th>History</th>
                <!-- <th>Assign</th> -->
                <th>Report</th>
                <th>Status</th>
                <th>Amount</th>
                <!-- <th>Action</th> -->
            </tr>
           
        </thead>
    
        
        <tbody  id="patientTable">
            
            {% for patient in patients %}
            <tr onclick="goToReport({{ patient.id }})" 
    style="cursor:pointer; background-color: {% if patient.status == 'FINAL' %}#e8f5e9{% elif patient.status == 'DRAFT' %}#fff3e0{% else %}#ffebee{% endif %}">

                <td>
                    
                    <input type="checkbox" class="rowCheckbox" data-id="{{patient.id}}" onclick="event.stopPropagation()">

                    <br>
                    <small>{{patient.entry_time|date:"d/m/Y"}} | {{patient.entry_time|time:"H:i"}}</small>
                </td>
                <td>
                    <strong>{{patient.name}}</strong><br>
                    <small>{{patient.patient_id}}</small>
                </td>
                <td>{{patient.age}}/{{patient.gender}}</td>
                <td>{{patient.scan_type}}</td>
                <td class="history-tooltip">
                    <strong>{{patient.body_part|upper}}</strong><br>
                    <small>{{patient.ref_by}}</small>
                </td>
                <td class="history-col">
                    <div class="history-tooltip">
                        {{ patient.history|truncatechars:35 }}
                        <div class="history-popup">
                            {{ patient.history }}
                        </div>
                    </div>
                </td>
                <!-- <td>
                    Dr. {{patient.ref_by}}<br>
                    <small>{{patient.entry_time|date:"d/m/Y"}}</small>
                </td> -->
                <td>
                    <i class="fa-regular fa-file-pdf" style="color:red; cursor:pointer; margin-right:8px;" 
                       onclick="downloadReport({{patient.id}}, 'pdf', event)"></i>
                    <i class="fa-regular fa-file-word" style="color:blue; cursor:pointer;" 
                       onclick="downloadReport({{patient.id}}, 'word', event)"></i>
                    <span class="status {{patient.status|lower}}">{{patient.status}}</span>
                </td>
                <td><span class="green-dot"></span></td>
                <td>â‚¹100</td>
                <!-- <td>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" 
                       onclick="deletePatient(event, {{patient.id}})"></i>
                </td> -->
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

{% endblock %}
<!-- ===== FOOTER PAGINATION ===== -->
<div id="footerPagination">

    <!-- LEFT -->
    <div id="pageSummary"> 1 of 1</div>
    <span style="text-align:center; padding:10px 0; color:#666; font-size:14px;">Copyright Â© 2025 MEDink</span>
        


    <!-- CENTER -->
    <div class="footer-center">
        
        <button onclick="prevPage()">Â«</button>
        <span id="displaySummary" class="display-mid">0 â€“ 0 of 0</span>
        <button  onclick="nextPage()">Â»</button>
        <select style="padding: 3px; font-size: 11px;" id="rowsPerPageSelect" onchange="changeRowsPerPage(this.value)">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <!-- <option value="15">15</option>
            <option value="20">20</option> -->
        </select>
    </div>
    

    <!-- RIGHT -->
    <!-- <div id="displaySummary"> 0 â€“ 0 of 0</div> -->

</div>



<script>
let currentPage = 1;
let rowsPerPage = 25;
// filteration
let currentStatusFilter = 'ALL';
let currentScanFilter = 'ALL';

function changeRowsPerPage(value) {
    rowsPerPage = parseInt(value, 10);
    currentPage = 1;   // hamesha page 1 se start
    paginateTable();
}

function filterByScanType(scanType) {
    currentScanFilter = scanType.toUpperCase();
    applyFilters();

    // Reset all scan options
    document.querySelectorAll(".scan-option").forEach(x => {
        x.classList.remove("active");
    });

    // Highlight clicked scan button
    const el = [...document.querySelectorAll(".scan-option")]
        .find(x => x.textContent.trim().toUpperCase() === scanType.toUpperCase());

    if (el) el.classList.add("active");
}



// Add these functions to your existing script section

function downloadReport(id, type, event) {
    event.stopPropagation();
    fetch(`/api/patient/${id}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(patient => {
            console.log('Patient data:', patient); // For debugging
            if(patient.status !== 'FINAL') {
                alert('Report can only be downloaded for finalized reports');
                return;
            }
            
            if(type === 'pdf') {
                generatePDF(patient);
            } else if(type === 'word') {
                generateWord(patient);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error downloading report');
        });
}

function generatePDF(patient) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add logo or header
    doc.setFontSize(20);
    doc.text('MEDINK REPORT', 105, 20, { align: 'center' });
    
    // Add patient details
    doc.setFontSize(12);
    doc.text('PATIENT DETAILS', 20, 40);
    doc.setFontSize(10);
    doc.text(`Patient ID: ${patient.patient_id}`, 20, 50);
    doc.text(`Name: ${patient.name}`, 20, 60);
    doc.text(`Age/Gender: ${patient.age}/${patient.gender}`, 20, 70);
    doc.text(`Scan Type: ${patient.scan_type}`, 20, 80);
    doc.text(`Body Part: ${patient.body_part}`, 20, 90);
    doc.text(`Referred By: Dr. ${patient.ref_by}`, 20, 100);
    
    // Add report content
    doc.setFontSize(12);
    doc.text('REPORT', 20, 120);
    doc.setFontSize(10);
    
    const reportText = patient.report || 'No report available';
    const splitReport = doc.splitTextToSize(reportText, 170);
    doc.text(splitReport, 20, 130);
    
    doc.save(`MEDINK_Report_${patient.patient_id}.pdf`);
}

function generateWord(patient) {
    const { Document, Paragraph, TextRun, HeadingLevel, Packer } = docx;
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: [
                new Paragraph({
                    text: "MEDINK REPORT",
                    heading: HeadingLevel.HEADING_1,
                    alignment: docx.AlignmentType.CENTER
                }),
                new Paragraph({
                    text: "PATIENT DETAILS",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(`Patient ID: ${patient.patient_id}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Name: ${patient.name}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Age/Gender: ${patient.age}/${patient.gender}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Scan Type: ${patient.scan_type}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Body Part: ${patient.body_part}`)]
                }),
                new Paragraph({
                    children: [new TextRun(`Referred By: Dr. ${patient.ref_by}`)]
                }),
                new Paragraph({
                    text: "REPORT",
                    heading: HeadingLevel.HEADING_2
                }),
                new Paragraph({
                    children: [new TextRun(patient.report || 'No report available')]
                })
            ]
        }]
    });

    Packer.toBlob(doc).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MEDINK_Report_${patient.patient_id}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
}

function exportSelectedToExcel() {
    const selectedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one patient to export');
        return;
    }

    const data = [];
    const headers = ['Patient ID', 'Name', 'Age/Gender', 'Scan Type', 'Body Part', 'History', 'Referred By', 'Status'];
    
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const rowData = {
            'Patient ID': row.querySelector('td:nth-child(2) small').textContent,
            'Name': row.querySelector('td:nth-child(2) strong').textContent,
            'Age/Gender': row.querySelector('td:nth-child(3)').textContent,
            'Scan Type': row.querySelector('td:nth-child(4)').textContent,
            'Body Part': row.querySelector('td:nth-child(5) strong').textContent,
            'History': row.querySelector('td:nth-child(6)').textContent,
            'Referred By': row.querySelector('td:nth-child(7)').textContent,
            'Status': row.querySelector('.status').textContent
        };
        data.push(rowData);
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Patients");
    XLSX.writeFile(wb, "selected_patients.xlsx");
}

function toggleSelectAll(checkbox) {
    const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
    rowCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}

// datae range
let selectedDateFilter = "TODAY";
let dayOffset = 0;   // 0 = today, 1 = yesterday ... max 7
let tempSelectedDay = dateOnly(new Date());

function dateOnly(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function getDateByOffset(offset) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return dateOnly(d);
}

function setDateFilter(type) {

    const chip = document.getElementById("dayChip");
    const allChips = document.querySelectorAll(".date-chip-box .chip");

    // remove active from all chips
    allChips.forEach(c => c.classList.remove("active"));

    // ðŸ”¹ TODAY
    if (type === "TODAY") {
        dayOffset = 0;
        selectedDateFilter = "TODAY";
        tempSelectedDay = getDateByOffset(0);

        chip.textContent = "TODAY";
        chip.classList.add("active");

        applyFilters();
        return;
    }

    // ðŸ”¹ MONTH
    if (type === "MONTH") {
        dayOffset = 0;
        selectedDateFilter = "MONTH";

        // MONTH chip ko active banao
        event.target.classList.add("active");

        applyFilters();
        return;
    }

    // ðŸ”¹ RANGE (calendar se)
    if (type === "RANGE") {
        dayOffset = 0;
        selectedDateFilter = "RANGE";

        applyFilters();
        return;
    }

    selectedDateFilter = type;
    applyFilters();
}

function formatChipDate(dateObj) {
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    const d = dateObj.getDate();
    const m = months[dateObj.getMonth()];
    return `${d}-${m}`;
}

function getDateByOffset(offset) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return dateOnly(d);
}

function goPrevDay() {

    if (dayOffset >= 7) return;   // max last 7 days

    dayOffset++;
    tempSelectedDay = getDateByOffset(dayOffset);
    selectedDateFilter = "DAY-JUMP";

    const chip = document.getElementById("dayChip");

    if (dayOffset === 1) {
        chip.textContent = "Y-DAY";          // âœ… exactly yesterday
    } else {
        chip.textContent = formatChipDate(tempSelectedDay); // âœ… date start
    }

    document.querySelectorAll(".date-chip-box .chip")
        .forEach(c => c.classList.remove("active"));

    chip.classList.add("active");

    applyFilters();
}



function goNextDay() {

    if (dayOffset <= 0) return;   // future not allowed

    dayOffset--;
    tempSelectedDay = getDateByOffset(dayOffset);

    const chip = document.getElementById("dayChip");

    if (dayOffset === 0) {
        chip.textContent = "TODAY";
        selectedDateFilter = "TODAY";
    } 
    else if (dayOffset === 1) {
        chip.textContent = "Y-DAY";
        selectedDateFilter = "DAY-JUMP";
    } 
    else {
        chip.textContent = formatChipDate(tempSelectedDay);
        selectedDateFilter = "DAY-JUMP";
    }

    document.querySelectorAll(".date-chip-box .chip")
        .forEach(c => c.classList.remove("active"));

    chip.classList.add("active");

    applyFilters();
}
window.onload = function () {

    dayOffset = 0;
    selectedDateFilter = "TODAY";
    tempSelectedDay = getDateByOffset(0);

    const chip = document.getElementById("dayChip");
    chip.textContent = "TODAY";
    chip.classList.add("active");

    filterPatients("ALL");
    filterByScanType("ALL");
    applyFilters();
    paginateTable();
    document.getElementById("rowsPerPageSelect").value = rowsPerPage;

    // Load profile data to update navbar icon
    fetchProfileData();

};



// ðŸŸ¢ SEARCH + FILTER COMBINED
// SEARCH + FILTER (FINAL WORKING VERSION)
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("keyup", applyFilters);
function applyFilters() {
    const rows = document.querySelectorAll("#patientTable tr");
    const searchText = searchInput.value.trim().toUpperCase();

    rows.forEach(row => {

        /* STATUS FILTER */
        const status = row.querySelector(".status")?.textContent.trim().toUpperCase();
        const statusMatch = currentStatusFilter === "ALL" || status === currentStatusFilter;

        /* SCAN FILTER */
        const scanType = row.querySelector("td:nth-child(4)")?.textContent.trim().toUpperCase();
        const scanMatch = currentScanFilter === "ALL" || scanType === currentScanFilter;

        /* SEARCH FILTER */
        const name = row.querySelector("td:nth-child(2) strong")?.textContent.trim().toUpperCase();
        const pid = row.querySelector("td:nth-child(2) small")?.textContent.trim().toUpperCase();
        const searchMatch = searchText === "" || name.includes(searchText) || pid.includes(searchText);

        /* DATE FILTER */
        let dateMatch = true;
        const dateText = row.querySelector("td small")?.textContent.split(" | ")[0];

        if (dateText) {
            const [d,m,y] = dateText.split("/");
            const entryDate = dateOnly(new Date(`${y}-${m}-${d}`));

            const today = dateOnly(new Date());
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);  
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            if (selectedDateFilter === "TODAY")
                dateMatch = (entryDate.getTime() === today.getTime());

            // if (selectedDateFilter === "YESTERDAY")
            //     dateMatch = (entryDate.getTime() === yesterday.getTime());

            if (selectedDateFilter === "DAY-JUMP")
                dateMatch = (entryDate.getTime() === tempSelectedDay.getTime());

            if (selectedDateFilter === "MONTH")
                dateMatch = (entryDate >= monthStart && entryDate <= monthEnd);

           if (selectedDateFilter === "RANGE" && startDate && endDate) {
                const s = dateOnly(startDate);
                const e = dateOnly(endDate);
                dateMatch = (entryDate >= s && entryDate <= e);
            }


        }

        const match = statusMatch && scanMatch && searchMatch && dateMatch;

// ðŸ”¥ FILTER RESULT MARK KARO
row.dataset.visible = match ? "1" : "0";

    });
    // ðŸ”¥ PAGINATION RESET AFTER FILTER
    currentPage = 1;
    paginateTable();
}

function filterPatients(status) {
    currentStatusFilter = status.toUpperCase();
    applyFilters();

    // Remove active from all
    document.querySelectorAll(".status-option").forEach(x => {
        x.classList.remove("active");
    });

    // Add active to clicked
    document.getElementById(`filter-${status.toLowerCase()}`).classList.add("active");
}



function openDateRange() {
    const box = document.getElementById("calendarContainer");
    box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}
function closeCalendar() {
    document.getElementById("calendarContainer").style.display = "none";
}

let selectedStart = null;
let selectedEnd = null;

const picker = new Litepicker({
    element: document.getElementById('calendarInput'),
    inlineMode: true,
    container: document.getElementById('litepickerInline'),
    singleMode: false,
    numberOfMonths: 1,
    numberOfColumns: 1,
    format: 'YYYY-MM-DD',
    autoApply: true, // autoApply off because we'll manually apply when both dates selected
    setup: (pickerInstance) => {
        pickerInstance.on('selected', (start, end) => {
            // start or end are Luxon-like objects from Litepicker; get native Date:
            selectedStart = start ? start.dateInstance : null;
            selectedEnd = end ? end.dateInstance : null;

            if (selectedStart && selectedEnd) {
                // update visible input (optional)
                document.getElementById('calendarInput').value =
                    pickerInstance.getStartDate('YYYY-MM-DD') + " â†’ " +
                    pickerInstance.getEndDate('YYYY-MM-DD');

                // set global range vars used by applyFilters()
                startDate = selectedStart;
                endDate = selectedEnd;
                selectedDateFilter = "RANGE";

                // close the calendar UI
                closeCalendar();

                // apply filters immediately
                applyFilters();
            }
        });

        // optional: if user clears selection, reset variables
        pickerInstance.on('clear', () => {
            selectedStart = null;
            selectedEnd = null;
            startDate = null;
            endDate = null;
            selectedDateFilter = "ALL";
            document.getElementById('calendarInput').value = '';
            applyFilters();
        });
    }
});


function applyDateRange() {
    if (!selectedStart || !selectedEnd) {
        alert("Please select a valid range.");
        return;
    }

    startDate = selectedStart;
    endDate = selectedEnd;
    selectedDateFilter = "RANGE";

    closeCalendar();
    applyFilters();
}



// report section
function goToReport(id) {
    const returnURL = window.location.pathname + window.location.search;
    window.location.href = `/report/${id}/?return=${encodeURIComponent(returnURL)}`;
}



// âœ… Auto-refresh countdown + refresh
document.addEventListener("DOMContentLoaded", function() {
    let countdown = 25; // 30 seconds timer
    const timerDisplay = document.getElementById("live-seconds");

   function updateTimer() {
        if (!timerDisplay) return;

        // Change color based on remaining seconds
        if (countdown > 5) {
            timerDisplay.style.color = "blue"; // normal
        }  else {
            timerDisplay.style.color = "red"; // danger
        }

        timerDisplay.textContent = countdown + "s";
        countdown--;

        if (countdown < 0) {
            countdown = 30; // reset timer
            refreshTbody(); // refresh tbody data
        }
    }

    // tbody refresh function
    function refreshTbody() {
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const newTbody = doc.querySelector("tbody");
            const oldTbody = document.querySelector("tbody");

            if (newTbody && oldTbody) {
                oldTbody.innerHTML = newTbody.innerHTML;

                // â­ Refresh à¤•à¥‡ à¤¬à¤¾à¤¦ filter à¤«à¤¿à¤° à¤¸à¥‡ apply à¤•à¤°à¥‹
                applyFilters();
            }
        })
        .catch(err => console.error("Error refreshing tbody:", err));
}


    // timer update every 1 second
    setInterval(updateTimer, 1000);
});

function paginateTable() {

    const rows = Array.from(document.querySelectorAll("#patientTable tr"))
        .filter(row => row.dataset.visible === "1");

    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;

    if (currentPage > totalPages) currentPage = totalPages;

    // hide all rows
    document.querySelectorAll("#patientTable tr")
        .forEach(r => r.style.display = "none");

    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

    rows.slice(startIndex, endIndex).forEach(r => {
        r.style.display = "";
    });

    // ðŸ”¹ FOOTER TEXT UPDATE
    document.getElementById("pageSummary").textContent =
        `Page ${currentPage} of ${totalPages}`;

    // document.getElementById("pageNumber").textContent = currentPage;

    document.getElementById("displaySummary").textContent =
        totalRows === 0
            ? " 0 â€“ 0 of 0"
            : ` ${startIndex + 1} â€“ ${endIndex} of ${totalRows}`;
}


function nextPage() {
    const rows = document.querySelectorAll('#patientTable tr[data-visible="1"]');
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    if (currentPage < totalPages) {
        currentPage++;
        paginateTable();
    }
}


function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        paginateTable();
    }
}

let cropper;
// Multiple images array
let selectedImages = [];
let currentCropIndex = -1;

/* OPEN / CLOSE POPUP */
function openPatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "flex";
    document.getElementById("pop_gender").value = "M"; // default
    document.getElementById("pop_scanType").value = "X-RAY";
    // Reset images
    selectedImages = [];
    currentCropIndex = -1;
    document.getElementById("selectedImagesPreview").style.display = "none";
    document.getElementById("imagesList").innerHTML = "";
    document.getElementById("pop_uploadScan").value = "";
}

function closePatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "none";
}

/* AUTO PATIENT ID */
function newPatientId() {
    let d = new Date();
    return `P${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.floor(1000+Math.random()*9000)}`;
}

/* GENDER */
document.querySelectorAll(".gender-btn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".gender-btn").forEach(x => x.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("pop_gender").value = btn.dataset.gender;
    };
});

/* IMAGE UPLOAD - MULTIPLE */
document.getElementById("pop_uploadScan").addEventListener("change", function () {
    const files = Array.from(this.files);
    if (files.length === 0) return;

    // Show preview container
    document.getElementById("selectedImagesPreview").style.display = "block";
    const imagesList = document.getElementById("imagesList");
    imagesList.innerHTML = "";

    // Process each file
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            // Add to array
            const imageData = {
                index: selectedImages.length,
                base64: e.target.result,
                cropped: null
            };
            selectedImages.push(imageData);

            // Create thumbnail preview
            const thumbDiv = document.createElement("div");
            thumbDiv.style.cssText = "position:relative; width:80px; height:80px; border:2px solid #ddd; border-radius:6px; overflow:hidden; cursor:pointer; background:#fff;";
            thumbDiv.innerHTML = `
                <img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">
                <div style="position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600;">${selectedImages.length}</div>
            `;
            
            // Click to crop this image
            thumbDiv.onclick = () => {
                currentCropIndex = selectedImages.length - 1;
                document.getElementById("cropImage").src = e.target.result;
                document.getElementById("cropEditor").style.display = "flex";
                
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropImage, { viewMode: 1, autoCropArea: 1 });
            };
            
            imagesList.appendChild(thumbDiv);
        };
        reader.readAsDataURL(file);
    });
});

/* CROP DONE - Update specific image */
function finishCrop() {
    if (currentCropIndex === -1 || !cropper) return;
    
    const canvas = cropper.getCroppedCanvas();
    const base64 = canvas.toDataURL("image/jpeg", 0.7);
    
    // Update the specific image in array
    selectedImages[currentCropIndex].cropped = base64;
    selectedImages[currentCropIndex].base64 = base64;
    
    // Update thumbnail
    const thumbs = document.querySelectorAll("#imagesList > div");
    if (thumbs[currentCropIndex]) {
        thumbs[currentCropIndex].querySelector("img").src = base64;
    }
    
    document.getElementById("cropEditor").style.display = "none";
    currentCropIndex = -1;
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

/* CLOSE CROPPER */
function closeCropper() {
    document.getElementById("cropEditor").style.display = "none";
    currentCropIndex = -1;
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

/* CSRF */
function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(";").forEach(c => {
        c = c.trim();
        if (c.startsWith(name + "=")) cookieValue = c.split("=")[1];
    });
    return cookieValue;
}

/* SUBMIT - Send multiple images */
document.getElementById("patientPopupForm").addEventListener("submit", function(e){
    e.preventDefault();

    if (selectedImages.length === 0) {
        alert("Please select at least one image");
        return;
    }

    let pid = pop_patientId.value.trim();
    if (!pid) pid = newPatientId();

    // Get all images (use cropped if available, else original)
    const imagesArray = selectedImages.map(img => {
        const imgData = img.cropped || img.base64;
        // Remove data:image prefix if present
        if (imgData.includes(',')) {
            return imgData.split(',')[1];
        }
        return imgData;
    });

    const data = {
        patient_id: pid,
        name: pop_patientName.value,
        age: pop_age.value,
        gender: pop_gender.value,
        history: pop_history.value,
        scanType: pop_scanType.value,
        bodyPart: pop_bodyPart.value,
        refBy: pop_refBy.value,
        scan: imagesArray,  // Send array instead of single image
        center: pop_center.value
    };

    fetch("/api/patient/add/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === "success") {
            closePatientPopup();
            location.reload();
        } else {
            alert(res.message);
        }
    });
});

function openPatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "flex";
}

function closePatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "none";
}

/* PROFILE DROPDOWN */
function toggleProfileDropdown() {
    const dropdown = document.getElementById("profileDropdown");
    dropdown.classList.toggle("show");
}

// Close dropdown when clicking outside
document.addEventListener("click", function(event) {
    const profileContainer = document.querySelector(".profile-container");
    const dropdown = document.getElementById("profileDropdown");
    
    if (profileContainer && !profileContainer.contains(event.target)) {
        if (dropdown) {
            dropdown.classList.remove("show");
        }
    }
});

/* PROFILE MODAL */
let profileEditMode = false;

function openProfileModal() {
    const overlay = document.getElementById("profileModalOverlay");
    overlay.style.display = "flex";
    
    // Close profile dropdown
    const dropdown = document.getElementById("profileDropdown");
    if (dropdown) {
        dropdown.classList.remove("show");
    }
    
    // Fetch profile data from backend
    fetchProfileData();
    
    // Reset edit mode
    profileEditMode = false;
    document.getElementById("profileEditBtn").style.display = "inline-block";
    document.getElementById("profileSubmitBtn").style.display = "none";
    document.querySelectorAll(".profile-input").forEach(i => {
        // Keep username and password always disabled (readonly)
        if (i.id === 'profileUsername' || i.id === 'profilePassword') {
            i.disabled = true;
        } else {
            i.disabled = true;
        }
    });
    document.getElementById("profileAvatarWrapper").classList.remove("editable");
}

// Fetch profile data from backend
function fetchProfileData() {
    fetch('/api/profile/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const profile = data.profile;
                
                // Update form fields
                document.getElementById("profileFullName").value = profile.name || '';
                document.getElementById("profileUsername").value = profile.username || '';
                document.getElementById("profilePassword").value = profile.password || 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                document.getElementById("profileEmail").value = profile.email || '';
                document.getElementById("profilePhone").value = profile.phone || '';
                
                // Update display name
                document.getElementById("profileNameDisplay").textContent = profile.name || 'User';

                // Update registration date
                document.getElementById("profileRegDate").textContent = profile.created_at || 'N/A';

                // Update profile picture in modal
                if (profile.profile_picture) {
                    document.getElementById("profileAvatar").src = profile.profile_picture.startsWith('data:')
                        ? profile.profile_picture
                        : `data:image/jpeg;base64,${profile.profile_picture}`;
                }

                // Update profile icon in navbar
                updateProfileIcon(profile.profile_picture);
            } else {
                alert('Error loading profile: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error fetching profile:', error);
            alert('Error loading profile. Please try again.');
        });
}

// Update profile icon in navbar
function updateProfileIcon(profilePicture) {
    console.log('updateProfileIcon called with:', profilePicture ? 'Present (' + profilePicture.length + ' chars)' : 'Not present');

    const profileIconImg = document.getElementById("profileIcon");
    const defaultIcon = document.getElementById("defaultProfileIcon");

    if (!profileIconImg || !defaultIcon) {
        console.error('Profile icon elements not found');
        return;
    }

    if (profilePicture && profilePicture.trim()) {
        let imageSrc;
        if (profilePicture.startsWith('data:')) {
            imageSrc = profilePicture;
        } else {
            imageSrc = `data:image/jpeg;base64,${profilePicture}`;
        }

        profileIconImg.src = imageSrc;
        profileIconImg.style.display = "block";
        profileIconImg.style.visibility = "visible";
        profileIconImg.style.opacity = "1";
        defaultIcon.style.display = "none";

        // Add error handling for image loading
        profileIconImg.onerror = function() {
            console.error('Failed to load profile image, falling back to default icon');
            profileIconImg.style.display = "none";
            defaultIcon.style.display = "block";
        };

        profileIconImg.onload = function() {
            console.log('Profile icon image loaded successfully');
            // Ensure full visibility
            profileIconImg.style.opacity = "1";
            profileIconImg.style.visibility = "visible";
        };

        profileIconImg.onabort = function() {
            console.error('Profile icon image loading aborted');
        };

        console.log('Profile icon update initiated');
    } else {
        profileIconImg.style.display = "none";
        defaultIcon.style.display = "block";
        console.log('Profile icon reset to default');
    }
}

function closeProfileModal() {
    const overlay = document.getElementById("profileModalOverlay");
    overlay.style.display = "none";
    
    // Reset form if in edit mode
    if (profileEditMode) {
        enableProfileEdit(); // Toggle to exit edit mode
    }
}

function enableProfileEdit() {
    profileEditMode = !profileEditMode;
    
    if (profileEditMode) {
        // Enable only editable fields (name, email, phone)
        // Username and password remain disabled (non-editable)
        document.getElementById("profileFullName").disabled = false;
        document.getElementById("profileEmail").disabled = false;
        document.getElementById("profilePhone").disabled = false;
        // Username and password stay disabled
        document.getElementById("profileUsername").disabled = true;
        document.getElementById("profilePassword").disabled = true;
        
        document.getElementById("profileSubmitBtn").style.display = "inline-block";
        document.getElementById("profileEditBtn").style.display = "none";
        document.getElementById("profileAvatarWrapper").classList.add("editable");
    } else {
        // Disable all fields
        document.querySelectorAll(".profile-input").forEach(i => i.disabled = true);
        document.getElementById("profileSubmitBtn").style.display = "none";
        document.getElementById("profileEditBtn").style.display = "inline-block";
        document.getElementById("profileAvatarWrapper").classList.remove("editable");
    }
}

function triggerProfileUpload() {
    if (profileEditMode) {
        document.getElementById("profileImageInput").click();
    }
}

// Profile image upload handler
function handleProfilePictureChange(event) {
    const file = event.target.files[0];
    if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            return;
        }

        const reader = new FileReader();
        reader.onload = () => {
            const base64Image = reader.result;
            document.getElementById("profileAvatar").src = base64Image;
            // Store the base64 data for form submission
            document.getElementById("profileAvatar").dataset.base64 = base64Image;
        };
        reader.readAsDataURL(file);
    }
}

// Attach the handler to the input
document.getElementById("profileImageInput").addEventListener("change", handleProfilePictureChange);

// Profile form submit handler
document.getElementById("profileForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    // Get form values
    const fullName = document.getElementById("profileFullName").value.trim();
    const email = document.getElementById("profileEmail").value.trim();
    const phone = document.getElementById("profilePhone").value.trim();
    
    // Validate name (required)
    if (!fullName) {
        alert("Full name is required!");
        return;
    }

    // Get profile picture data
    const profileAvatar = document.getElementById("profileAvatar");
    let profilePicture = null;

    if (profileAvatar.dataset.base64) {
        // New image uploaded - extract base64 data without prefix
        const base64Data = profileAvatar.dataset.base64;
        if (base64Data.includes(',')) {
            profilePicture = base64Data.split(',')[1];
        } else {
            profilePicture = base64Data;
        }
    }

    // Prepare data to send (only editable fields)
    const data = {
        name: fullName,
        email: email || null,  // Send null if empty (optional)
        phone: phone || null,  // Send null if empty (optional)
        profile_picture: profilePicture  // Send base64 without prefix
    };
    
    // Disable submit button while saving
    const submitBtn = document.getElementById("profileSubmitBtn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Saving...";
    
    // Debug: Log the data being sent
    console.log('Sending profile update data:', {
        name: fullName,
        email: email,
        phone: phone,
        profilePicture: profilePicture ? 'Present (' + profilePicture.length + ' chars)' : 'Not present',
        dataObject: data
    });

    // Debug: Show data being sent
    console.log('Sending profile update:', { name: fullName, email, phone, hasProfilePic: !!profilePicture });

    // Send data to backend
    const csrfToken = getCookie("csrftoken");
    console.log('CSRF Token:', csrfToken);  // Debug log

    fetch('/api/profile/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
            // 'X-CSRFToken': csrfToken  // Temporarily removed for testing
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        // Debug: Log the response
        console.log('Profile update response:', result);

        // Debug: Log response status
        console.log('Profile update result:', result.status, result.message);

        if (result.status === 'success') {
            // Update display name
            document.getElementById("profileNameDisplay").textContent = result.profile.name;
            
            // Update registration date if returned
            if (result.profile.created_at) {
                document.getElementById("profileRegDate").textContent = result.profile.created_at;
            }
            
            // Exit edit mode
            profileEditMode = false;
            document.getElementById("profileFullName").disabled = true;
            document.getElementById("profileEmail").disabled = true;
            document.getElementById("profilePhone").disabled = true;
            document.getElementById("profileSubmitBtn").style.display = "none";
            document.getElementById("profileEditBtn").style.display = "inline-block";
            document.getElementById("profileAvatarWrapper").classList.remove("editable");
            
            // Update profile picture in modal if changed
            if (result.profile.profile_picture) {
                const profilePicUrl = result.profile.profile_picture.startsWith('data:')
                    ? result.profile.profile_picture
                    : `data:image/jpeg;base64,${result.profile.profile_picture}`;
                document.getElementById("profileAvatar").src = profilePicUrl;
                // Clear the temporary base64 data
                delete document.getElementById("profileAvatar").dataset.base64;
            }

            // Update profile icon in navbar immediately
            setTimeout(() => {
                updateProfileIcon(result.profile.profile_picture);
            }, 100);

            // Update welcome message in navbar if needed
            const welcomeSpan = document.querySelector(".profile-container span");
            if (welcomeSpan) {
                welcomeSpan.textContent = `Welcome, ${result.profile.name}`;
            }

            // Close modal after successful update
            setTimeout(() => {
                closeProfileModal();
                alert("Profile updated successfully!");
            }, 500);
        } else {
            alert("Error: " + (result.message || "Failed to update profile"));
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
        }
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        alert("Error updating profile. Please try again.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
    });
});

// Close modal when clicking outside
document.getElementById("profileModalOverlay").addEventListener("click", function(e) {
    if (e.target === this) {
        closeProfileModal();
    }
});

// Load profile data on page load
window.addEventListener('load', function() {
    // Load profile data to update navbar icon
    fetchProfileData();
});
</script>
</body>
</html>