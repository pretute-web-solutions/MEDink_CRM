
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Cropper overrides: force solid black backgrounds and remove checkerboard -->
    <style>
    /* Force all cropper layers to solid black (remove checkerboard) */
    .cropper-container,
    .cropper-wrap-box,
    .cropper-canvas,
    .cropper-view-box,
    .cropper-face,
    .cropper-bg,
    .cropper-bg::before,
    .cropper-bg::after {
        background-image: none !important;
        background-color: #000 !important;
        background: #000 !important;
    }

    /* Remove any transparent patterns */
    .cropper-container, .cropper-container *,
    .cropper-container *::before, .cropper-container *::after,
    .cropper-bg, .cropper-bg::before, .cropper-bg::after,
    .cropper-face, .cropper-face::before, .cropper-face::after,
    .cropper-canvas, .cropper-wrap-box, .cropper-view-box {
        background-image: none !important;
        background: #000 !important;
        background-color: #000 !important;
    }

    /* Ensure the image element background is black */
    #cropImage {
        background-color: #000 !important;
        display: block;
    }

    /* Make cropper UI elements white */
    .cropper-line {
        background-color: white !important;
        border-color: white !important;
    }

    .cropper-dashed {
        border-color: white !important;
        background-color: white !important;
    }

    .cropper-point {
        background-color: white !important;
        border-color: white !important;
        opacity: 1 !important;
    }

    .cropper-view-box {
        outline: 2px solid white !important;
        box-shadow: none !important;
    }

    /* Add gap/margin to cropper container */
    .cropper-container {
        padding: 20px 0 !important;
        margin: 20px 0 !important;
    }

    /* Hide cropper modal overlay elements */
    .cropper-modal {
        background-color: transparent !important;
    }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>



    <style>
       /* üåê GLOBAL STYLE */
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
}
.assign-dropdown {
    width: 85px;        /* FIXED WIDTH */
    height: 20px;        /* FIXED HEIGHT */
    padding: 2px 6px;
    font-size: 13px;
    border: 1px solid #d6d5d5;
    border-radius: 5px;
    background: #fff;
    cursor: pointer;
    gap: 4px; 
    font-size: 12px;


    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;

    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    /* text truncate */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;

    /* custom arrow */
    background-image: url("data:image/svg+xml;utf8,<svg fill='%23000' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M5.5 7l4.5 4.5L14.5 7z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 5px center;  /* üî• arrow ko paas lao */
    background-size: 10px;
}
.assign-dropdown option {
    font-size: 12px;
}

/* üîπ HISTORY TOOLTIP */
.history-tooltip {
    position: relative;
    max-width: 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
}

/* popup box */
.history-tooltip .history-popup {
    display: none;

    position: fixed;   /* üî• FIXED ‚Äì not absolute */

    background: #1f2937;
    color: #fff;
    padding: 10px 12px;
    border-radius: 8px;

    min-width: 280px;
    max-width: 420px;
    max-height: 220px;

    font-size: 12px;
    line-height: 1.4;

    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    z-index: 999999;   /* üî• above everything */

    white-space: normal;
    word-break: break-word;
    overflow-y: auto;
}


/* arrow */
.history-tooltip .history-popup::before {
    content: "";
    position: absolute;
    top: -6px;
    left: 18px;
    border-width: 6px;
    border-style: solid;
    border-color: transparent transparent #1f2937 transparent;
}

/* show on hover */
.history-tooltip:hover .history-popup {
    display: block;
}

/* üß≠ TOP NAVBAR */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: #d6eefe; /* Light Sky Blue */
    color: #0d47a1;            /* Deep Blue Text */

    display: flex;
    align-items: center;
    padding: 0 15px;
    /* color: black; */
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.top-navbar img {
    border-radius: 50%;
}

.top-navbar span {
    font-weight: bold;
    margin-left: 15px;
    font-size: 1.1rem;
}

/* Search Icon Styles - Hidden by default, only show on mobile */
#navbarSearchIcon {
    display: none;
    transition: opacity 0.3s ease;
}

#navbarSearchIcon:hover {
    opacity: 0.7;
}

/* Logout Icon Styles */
.top-navbar a[href*="logout"] {
    display: flex;
    align-items: center;
    justify-content: center;
    color: red;
    text-decoration: none;
    transition: opacity 0.3s ease;
}

.top-navbar a[href*="logout"]:hover {
    opacity: 0.8;
}

/* üìë SIDEBAR */
.sidebar2 {
    position: fixed;
    top: 60px;
    left: 0;
    height: 100%;
    width: 60px;
    background-color: #d6eefe; /* Light Blue */
color: #0d47a1;            /* Dark Blue Icons */

    transition: width 0.3s ease;
    overflow-x: hidden;
    z-index: 1000;
}

.sidebar2:hover {
    width: 130px;
}

.sidebar2 a {
    display: flex;
    align-items: center;
    color: white;
    padding: 12px;
    text-decoration: none;
    font-size: 18px;
    white-space: nowrap;
    transition: background-color 0.3s ease;
}

.sidebar2 a:hover {
    /* background-color: white; */
    border-radius: 30px;
    /* color: black; */
    background-color: #e8f1ff;
    color: #0d47a1;
    
}

.sidebar2 a i {
    min-width: 40px;
    text-align: center;
    color: #1f5ab3;
}

.sidebar2 a span {
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    color: gray;
}

.sidebar2:hover a span {
    opacity: 1;
    transform: translateX(0);
}
/* üîÑ Hide Sidebar when toggled */
.sidebar-hidden {
    width: 0 !important;
    overflow: hidden;
}



/* Toggle Button */
.toggle-btn {
    position: fixed;
    top: 500px;
    left: 10px;
    background-color: rgb(190, 190, 193);
    color: black;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 5px;
    z-index: 1000;
    transition: left 0.3s;
}
/* ‚úÖ Make nav2 fixed just below top navbar */
.nav2 {
    position: absolute;
    top: 60px; /* top navbar height */
    left: 60px; /* sidebar width */
    right: 0;
    /* background-color: #606160;
    color: white; */
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding: 10px;
    z-index: 900;
    height: auto;
    transition: left 0.3s ease;
    background-color: white;
    border-bottom: 1px solid #cfd8dc;
    color: #0d47a1;
}

/* ‚úÖ nav3 (table area) scrollable */
/* .nav3 {
    position: absolute;
    top: 100px;
    left: 60px;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    transition: left 0.3s ease;
    padding-bottom: 50px;
} */
.nav3 {
    position: absolute;
    top: 125px !important; /* (60 nav + 40 filters + 30 tabs) */
    left: 60px;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    transition: left 0.3s ease;
    padding-bottom: 50px;
    
}


/* ‚úÖ Scrollbar style (optional) */
.nav3::-webkit-scrollbar {
    width: 8px;
}
.nav3::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 4px;
}

/* ‚úÖ When sidebar hidden */
.sidebar-hidden ~ .nav2 {
    left: 0 !important;
}
.sidebar-hidden ~ .nav3 {
    left: 0 !important;
}


/* ‚úÖ Body should not scroll */
body {
    overflow: hidden;
}



.nav2 button, .nav2 a {
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.nav2 button.active-filter {
    background-color: #007bff;
    color: white;
}





.nav3 table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.nav3 th, .nav3 td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.nav3 th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* üü¢ STATUS COLORS */
.status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.status.unread { background-color: #ffebee; color: red; }
.status.draft { background-color: #fff3e0; color: orange; }
.status.final { background-color: #e8f5e9; color: green; }

.green-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: green;
    border-radius: 50%;
}


#refreshTimer {
  font-size: 14px;
  color: #007bff;
}

#nav3 {
  max-height: 450px;         /* scroll height adjust kar lo */
  overflow-y: auto;           /* sirf vertical scroll */
  border: 1px solid #ddd;     /* optional border */
}

#nav3 table {
  width: 100%;
  border-collapse: collapse;
}

#nav3 thead th {
  position: sticky;
  top: 0;
  background-color: rgb(230, 228, 228);    /* ya apne theme ke hisab se */
  z-index: 10;
  border-bottom: 2px solid #ccc;
}

#nav3 th, #nav3 td {
  padding: 8px 12px;
  text-align: left;
  border: 1px solid #eee;
}

#statusFilter .active {
  color: #00ffcc;
  font-weight: bold;
}
/* EVERY ENTRY ROW SOFT LIGHT BLUE */
tr {
    background-color: #f7fbff !important;   /* universal super-light blue */
}

/* OPTIONAL: Row hover soft highlight */
tr:hover {
    background-color: #eef6ff !important;
}
tr.status-final  { background-color: #f2fbf2 !important; }  /* light mint */
tr.status-unread { background-color: #fff4f4 !important; }  /* light pink */
tr.status-draft  { background-color: #fef9e7 !important; }  /* cream */

/* dark mode */

/* SIMPLE TOGGLE SWITCH */
.theme-switch {
  position: relative;
  display: inline-block;
  width: 66px;
  height: 20px;
  margin-left: 400px;
}

.theme-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.theme-switch .slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.theme-switch .slider:before {
  position: absolute;
  content: "";
  height: 15px;
  width: 17px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

/* CHECKED STATE */
.theme-switch input:checked + .slider {
  background-color: #2196F3;
}

.theme-switch input:checked + .slider:before {
  transform: translateX(26px);
}
/* DARK MODE */
body.dark-mode {
  background: #0f172a;
  color: #e2e8f0;
}

body.dark-mode .top-navbar {
  background: #1a2234 !important;
  color: #e2e8f0 !important;
}

body.dark-mode .sidebar2 {
  background: #1a2234 !important;
}

body.dark-mode .nav2 {
  background: #1a2234 !important;
  color: #e2e8f0 !important;
}

body.dark-mode .nav3 table tr {
  background: #1e293b !important;
  color: #e2e8f0 !important;
}

body.dark-mode .nav3 table tr:hover {
  background: #2d3b50 !important;
}

/* date filter */

/* Date range */
.date-chip-box {
    display: flex;
    align-items: center;
    /* gap: 8px; */
    background: #ffffff;
    border: 1px solid rgb(217, 217, 217);
    /* padding: 8px 10px; */
    border-radius: 5px;
    font-size: 12px;
    font-weight: 500;
}

.chip {
    cursor: pointer;
    padding: 0 6px;
    color: #1f1f20;
    font-weight: 500;
}

.chip.active {
    color: #007bff;
    font-weight: 500;
    font-weight: 600;
}

.divider {
    color: #b0b0b0;
}

.calendar-icon {
    padding: 4px 6px;
    cursor: pointer;
    background: #ffffff;
    border-radius: 6px;
    /* border: 1px solid #c9dfff; */
}

.calendar-icon i {
    color: #007bff;
    font-size: 14px;
}
#dayChip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 60px;       /* FIXED WIDTH */
    height: 26px;
    padding: 0 !important;
    text-align: center;
}
.add-btn {
    background: #007bff;  
    width: 100px;         /* blue */
    color: white;
    font-weight: 600;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;            /* smooth rounded */
    font-size: 15px;
    display: inline-flex;
    align-items: center;
    gap: 6px;                      /* icon gap */
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    transition: 0.25s ease-in-out; /* smooth animation */
}

.add-btn:hover {
    background: #0056d2;           /* darker blue on hover */
    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.45);
    transform: translateY(-2px);   /* small lift effect */
}

.add-btn:active {
    transform: scale(0.96);        /* click animation */
}
.status-option.active {
    font-weight: 700 !important;
    color:  #007bff !important;
}
.filter-box {
    display: flex;
    /* gap: 10px; */
    padding: 1px 8px;
    border: 1px solid rgb(204, 204, 204);
    border-radius: 5px;
    background: white;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
    align-items: center;
}

.filter-item {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 4px 7px;
    border-right: 1px solid #ccc;
    position: relative;
    cursor: pointer;
}

.filter-item:last-child {
    border-right: none;
}

.filter-label {
    font-size: 12px;
    /* font-weight: 700; */
    color: black;
}

.filter-item i {
    font-size: 10px;
    color: black;
}

/* Hide the original select */
.hidden-select {
    position: absolute;
    opacity: 0;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.scan-option {
    color: black !important;
    font-weight: 400 !important;
    cursor: pointer;
    padding: 0 6px;
}

.scan-option.active {
    color: #007bff !important;
    font-weight: 700 !important;
}
/* ===== FOOTER PAGINATION ===== */
#footerPagination {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 45px;
    background: #ffffff;
    border-top: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 9999;
    font-size: 13px;
}

.footer-center {
    display: flex;
    align-items: center;
    gap: 8px;
}

#pageSummary,
#displaySummary {
    font-size: 12px;
    color: #6b7280;
}

#footerPagination select {
    padding: 4px 6px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

#footerPagination button {
    padding: 4px 8px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 5px;
    cursor: pointer;
}

#pageNumber {
    background: #007bff;
    color: #fff;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
}

/* Chrome, Edge, Safari */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Firefox */
input[type=number] {
    -moz-appearance: textfield;
}

.modal {
  width: 570px;
  background: #fff;
  margin: 40px auto;
  border-radius: 14px;
  height: auto;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.modal-header {
  background: linear-gradient(90deg, #007bff , #1e88e5);
  text-align: center;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.modal-header h2 {
  color: #fff;
  margin: 0;
  font-weight: 500;
  font-size: 18px;
}

.patient-form {
  padding: 16px;
}

.row {
  display: flex;
  gap: 14px;
  margin-bottom: 14px;
}

.field {
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-top: auto;
}

.field label {
  font-size: 13px;
  margin-bottom: 4px;
  color: #555;
}

.field input,
.field select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #d0d7e2;
  font-size: 13px;
  transition: all 0.3s ease;
}

.field input:focus,
.field select:focus {
  border-color: #1e88e5;
  box-shadow: 0 0 0 2px rgba(30,136,229,0.15);
  outline: none;
}

.gender {
  max-width: 100px;
}

.gender-box {
  display: flex;
  background: #f1f4f9;
  border-radius: 10px;
  overflow: hidden;
  height: 35px;
  margin-top: auto;
  margin-left: -30px;
}

.gender-box span {
  flex: 1;
  text-align: center;
  line-height: 35px;
  cursor: pointer;
  font-weight: 500;
  color: #555;
}

.gender-box span.active {
  background: #007bff;
  color: #fff;
}

.bottom-row {
  align-items: center;
  justify-content: space-between;
}

.upload-box {
  background: #f1f4f9;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  color: #1e88e5;
  border: 1px dashed #1e88e5;
}

.upload-box:hover {
  background: #e3f2fd;
}

.submit-btn {
  padding: 16px 30px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(90deg, #007bff , #1e88e5);
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.submit-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 15px rgba(30,136,229,0.4);
}

    </style>
</head>
<body>  
<!-- side navbar -->
 <div class="sidebar2">
    <a href="#"><i class="fas fa-bars"></i><span></span></a>
    <a href="{% url 'index' %}"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="{% url 'signup' %}"><i class="fas fa-user"></i><span>User</span></a>
    <a href="#"><i class="fas fa-cog"></i><span>Settings</span></a>
    <a href="{% url 'invoice' %}"><i class="fa-solid fa-file-invoice"></i><span>Invoice</span></a>
     <!-- üî• Sidebar Logout -->
    <a href="{% url 'logout' %}" style="margin-top:auto; border-radius:8px;">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
    </a>
  
    <!-- hise sidebar button -->
</div>

</div>
  <div class="toggle-btn" id="toggleBtn">
  <i class="fas fa-chevron-left"></i>
</div>

<div class="top-navbar">
    <img height="40" style="border-radius: 30px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQMAAADCCAMAAAB6zFdcAAAAdVBMVEX///88bLQ3abNpi8MnYa91k8ba4vD09voiX64rY7DEz+To7fU5arNIdbkzZ7IwZbG8y+Pg5/LK1ehSe7t+msqoutp0k8b2+fxrjMOTqtKLpM+uv9zQ2utVfbycsdW2xeBhhcAbW62En8yNps+Zr9QAUqoQV6w5NsUUAAAHHUlEQVR4nO2c0ULyOgyAR6mug25DQVBRAfU/7/+IR0AURpMmpZlc5LuGbvvWZm2arSgURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVEURVGUq+NjfgMxnzHbGj2CbaHMZ89vy5dS5PooDFsD4la8tnwDt4XTNJV1zWzyNx6GZgDimwWnqacWboqCN5V7nLAOmQfMwaB5Z7Q0dpcp2GFs+3EndrEAqIOBvc3VEhnfuOG93PXyz9xMyQ2NcnSD76O66Ujwks+I3D37QG3IZ1PwhbfTHvtCxIFvx7R2Lg2IZwd2w97iQmwUNzekZrIExFOMfRK+9gPRSOZInTJTQDylql+kL5928r4mtJIxIJ4c232ICygoN7B9i7cyyBoRj6imPUwdCZ3YRcPiZyWkYPuclB8PBAdmGGljbMUUfI2HzfIKHAxcZMbyKBEQjw7/eQUOvEebuJcJiL/Y5793MGjRk6ilAmJfEmgPdofM2d7kAuIPVnQ40ByYV7CBcSXeDb5wkoGROMGz4DnMG+AvpiLR0E5A8hFJdOBbIL8DBkQzvx/FmSyfbuqNbeJ9qSEu3uQcDFogwQoFRF/Rz7m8fzYO6k4/Ttd5LjgAebET7owPUECsyImHPbfvNhJYLGHOngbZgQ+llEpoJJBWWh2WBrcQn7MnQl/0hu7sHPo3bcXdZdlgI0JsNNAdBFJKL3BATDubxYdFukJszp4KI/lxnlLKERA73NZYUu6ya4XgJIC6HRwOiJdM62bwKtQyN76IcBx0Al0JhTB/2f16cNB4uLBhCFYi8PT+3kAB7NJxOwKDghXJuPOSocePJzggxnIuUeDJ58VNh+A5OH48TaGbtbn8Ob6CJFiJOQIzKe4mhz+CAbHNsS3wDLTOnX6SABxAZnz7/b+yhQKiyXJeQC/z8CI+nbADM4Pi3WE7HvzBb0+5iDtgNKTPPGDCDtwYuMKv0b5LKcEBcZ3pxN7Dkqs8ik8AHCxW0Exlv3Z6BRcKuXZKgR1MVlkIEcBBCV/lNqW0hAy1+TbHZsETCC5fLwR0cAsui9tFCeV9vMlXTnQf9Oyb/JtvoAM46jXvH9C6JuuE3gdFO0Z5EBHYQQnOWA00TPKu8MODQSAowg7gWRAIp4QrzjJ4/Db/LAlxwN5AyhyzX4IBQeDBgDkAJwFhfAuHq5RQGU5WpqaoEDAHzA1lJCAuU2YNi2Blh0BWEXXAKixAahkXaUvJ4JpBYMWAOmDtpyIB8TnNwWvQQf5JEu6AUWjUwJX+dzZta2AdOreUnYsIEQcTalj0FRwQ1ybNQbgf9O6AnGNBkhsTm7hFdB3xYNuPSQqQu7MYpG6T1cEj9e+geI5tCO/YwOUB28VFkoNFcGUmkFaNOlgYQlhEJi67hFCSg3AGwdAKqDlEHRRgNgX4fYddcE9yEF48N/lLk+IOimk0LFZwacD+wZLk4C24Qq/yVyYRHIDZlAPY42o/ppMcBKcHEltNBAdwNuXwa/i0vl/tSHFQhsegwC4LxQG4uboHCYjjzSDZwSo4FCS2XSkOItkU5M4cunOKg+AsUWTHkeQAzaYgxQaTQ3dOcADsu1LepuBCc4CUZWMB8bc9voNwN8icrttDc4BkUyxcbPD7rhvfAbCDESmhT4PoAHxvzTyCTR9lYNgOoOwNskJPh+ig+AS2FCycJTtqmu2gBvqdSCEK1UERPimk2GB0dCu5DobAjCTTxn73aFQH4WwKck7HzxKmg0doH0tgsVAwHASnrhbe9Dl5143nYAiWKMqU69IdBJYNSJ77NKhxzn08BRUYiYjIcRDIpiDFBqcPU4aDEfJSR4ZqrxAMB2U3m9LAr1p1Xv4lO1jMwAJNoQdjwXLQnbeA77YUZ5NrqoOVwaqVrdB7vxwHnWwKsrfWTX/QHIymWNU643sUTFgOTnaCsXfdurM8goNyWaMGON8lYcJycFKivIFXL2eri5iDcnTTxt4RzFbtdQbPwdHLjC1cB3C+ykRyrovx6G3d2mj22kmNBK6D34GOFRsENilriKaytiGk75v8ZQc/MB38XB/80md4s9pDRK9+h1wwKPgOvvs5ck4Cn4f5Ei/5OQyug+8/IBVyAl9D8I3od4LYDnapYmTGJvA1BGEFfAfbDBlWLJr/awhGWEGCg8J4vNggM81A7m3vPQkOVg4J0pPcX4Ro1+JfVExwUNRIUi+zA++Ev4WyJcUB1jfzOjASr2yckeIAI6sDu5YOBTuu2IERXCKccLUOvJv39ZXdK3Xg7bSf7wZuuUoH3tZ9xMIDV+jA2Nc+DVyfA9/ax/5GwZ6rcuBbV7/18jg84VoceNNUrv4QqLCIs97YAP+SHaz+C7UXwzm/fl/1/pHxb+5ugyS3V4bbizD+gy/NK4qiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKIqiKBfwPy/9ZUL+NldGAAAAAElFTkSuQmCC" alt="Profile">
    
    <span style="margin-left: 100px;" ></span>
    <h3>Welcome, {{ user_name }} </h3>
    <label class="theme-switch">
  <input type="checkbox" id="themeToggle">
  <span class="slider"></span>
</label>

    <!-- üîµ Search, Logout and Profile Icons on Right -->
    <div style="margin-left:auto; display:flex; align-items:center; gap:15px;">
        <!-- Search Icon -->
        <div style="cursor:pointer;" id="navbarSearchIcon" title="Search">
            <i class="fas fa-search" style="font-size: 20px; color: white;"></i>
        </div>

        <!-- Logout Icon -->
        <a href="{% url 'logout' %}" style="color: red; font-size: 24px; text-decoration: none;" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </a>

        <!-- Profile Icon -->
        <div style="cursor:pointer;">
            <i class="fa-solid fa-user-circle"
               style="font-size:30px; color:white;" id="profileIcon"></i>
        </div>
    </div>

    <!-- üîç Navbar Search Input (Hidden by default) -->
    <div id="navbarSearchContainer" style="display: none; position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #ddd; z-index: 1001;">
        <input type="search" id="navbarSearchInput" placeholder="Search patients..."
               style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px; font-size: 14px;">
        <button onclick="performNavbarSearch()" style="margin-left: 8px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
    </div>

<!-- Profile Dropdown Modal -->
<div id="profileModal" style="
    position: fixed;
    top: 70px;
    right: 20px;
    width: 220px;
    background: white;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 99999;
    display: none;
    font-family: Arial;
">

    <!-- Header -->
    <div style="padding: 10px; border-bottom: 1px solid #eee;">
        <strong style="font-size: 16px;">{{user_name}}</strong><br>
        <small style="color: gray;">Role: {{user_type}}</small>
    </div>

    <!-- Menu Items -->
    <div style="padding: 10px;">
        <div class="profile-item" onclick="openMyProfile()">üë§ My Profile</div>
        <div class="profile-item" onclick="openChangePass()">üîë Change Password</div>
        <div class="profile-item" onclick="toggleTheme()">üåó Theme Mode</div>
        <div class="profile-item" onclick="window.location.href='{% url 'logout' %}'">üö™ Logout</div>
    </div>
</div>

<style>
.profile-item {
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 5px;
}
.profile-item:hover {
    background: #e8f1ff;
}
body.dark-mode #profileModal {
    background: #1e293b;
    color: white;
}
body.dark-mode .profile-item:hover {
    background: #334155;
}

.tab-item {
    padding: 3px 8px;
    font-size: 12px;
    background: #d7e9ff;
    border-radius: 6px;
    border:1px solid #bcd4f5;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tab-active {
    background: #1d6ede !important;
    color: white !important;
    border-color: #1055b6 !important;
}

/* üì± MOBILE RESPONSIVE - Hide Sidebar */
@media (max-width: 768px) {
    .sidebar2 {
        display: none !important;
        width: 0 !important;
        visibility: hidden !important;
        overflow: hidden !important;
    }

    .toggle-btn {
        display: none !important;
    }

    .nav2 {
        left: 0 !important;
    }

    .nav3 {
        left: 0 !important;
        top: 90px !important; /* Adjust for smaller mobile navbar (45px) */
        padding-bottom: 55px !important; /* Footer height 45px + some margin */
    }

    #patientTabs {
        left: 0 !important;
    }

    /* Mobile navbar adjustments */
    .top-navbar {
        padding: 0 8px !important;
        height: 45px !important;
    }

    .top-navbar img {
        height: 30px !important;
        width: 30px !important;
    }

    .top-navbar span {
        font-size: 0.8rem !important;
        margin-left: 8px !important;
    }

    /* Hide theme switch on mobile to make space */
    .theme-switch {
        display: none !important;
    }

    /* Reduce spacer on mobile */
    .top-navbar span[style*="margin-left"] {
        margin-left: 20px !important;
    }

    /* Ensure logout icon is visible on mobile */
    .top-navbar a[href*="logout"] {
        display: flex !important;
        font-size: 16px !important;
        color: red !important;
        margin: 0 !important;
    }

    .top-navbar > div:last-child {
        gap: 8px !important;
        margin-right: 8px !important;
    }

    /* Hide profile icon on mobile */
    .top-navbar #profileIcon {
        display: none !important;
    }

    /* Mobile search adjustments */
    #navbarSearchContainer {
        top: 45px !important;
        right: 8px !important;
        left: 8px !important;
        width: calc(100vw - 16px) !important;
    }

    #navbarSearchInput {
        width: calc(100% - 80px) !important;
    }

    /* Show search icon only on mobile */
    #navbarSearchIcon {
        display: block !important;
        font-size: 18px !important;
    }

    /* Hide original search input and icon from nav2 on mobile */
    .nav2 #searchInput,
    .nav2 a[href*=""] {
        display: none !important;
    }

    /* Mobile logout and profile icons */
    .top-navbar > div:last-child {
        gap: 10px !important;
    }

    .top-navbar a[href*="logout"] {
        font-size: 20px !important;
    }
}

</style>
<script>
// Open / Close Dropdown
const profileIcon = document.getElementById("profileIcon");
const profileModal = document.getElementById("profileModal");

profileIcon.addEventListener("click", () => {
    profileModal.style.display =
        profileModal.style.display === "block" ? "none" : "block";
});

// Close modal when clicking outside
document.addEventListener("click", function(e) {
    if (!profileModal.contains(e.target) && e.target !== profileIcon) {
        profileModal.style.display = "none";
    }
});

// Dummy functions
function openMyProfile() {
    alert("My Profile open karna hai (link add karna hoga)");
}
function openChangePass() {
    alert("Change password page banega (yahan redirect karenge)");
}

// Theme Toggle
function toggleTheme() {
    document.getElementById("themeToggle").click();
}

// üîç Navbar Search Functionality
document.getElementById("navbarSearchIcon").addEventListener("click", function() {
    const searchContainer = document.getElementById("navbarSearchContainer");
    const isVisible = searchContainer.style.display === "block";

    if (isVisible) {
        searchContainer.style.display = "none";
    } else {
        searchContainer.style.display = "block";
        document.getElementById("navbarSearchInput").focus();
    }
});

// Close search when clicking outside
document.addEventListener("click", function(e) {
    const searchContainer = document.getElementById("navbarSearchContainer");
    const searchIcon = document.getElementById("navbarSearchIcon");

    if (!searchContainer.contains(e.target) && e.target !== searchIcon && !searchIcon.contains(e.target)) {
        searchContainer.style.display = "none";
    }
});

// Real-time search as user types
document.getElementById("navbarSearchInput").addEventListener("input", function(e) {
    performNavbarSearch();
});

// Search on Enter key (optional - for manual search)
document.getElementById("navbarSearchInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        // Close the search dropdown after search
        document.getElementById("navbarSearchContainer").style.display = "none";
    }
});

function performNavbarSearch() {
    const searchTerm = document.getElementById("navbarSearchInput").value.trim();

    // Use existing search input and trigger search (works even with empty string to clear search)
    document.getElementById("searchInput").value = searchTerm;
    applyFilters();

    // Don't close dropdown automatically - let user close it manually or keep typing
}
</script>
</div>

{% block body %}

<div id="nav2"  class="nav2">
   <button style="font-weight: 600;" class="add-btn" onclick="openPatientPopup()">
    <i class="fas fa-user-plus"></i> Add New
</button>


<div id="statusFilter" style="padding: 6px; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); gap background-color: white; border-radius: 5px; font-size:12px; font-weight: 500; margin-left: 0px; border: 1px solid #ccc; margin-top: 0px; ">
    <span id="filter-all" class="status-option" style="cursor:pointer; padding: 0 6px;" onclick="filterPatients('ALL')">All</span><span style="color: black;"> |</span>
    <span id="filter-final" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('FINAL')">FINAL</span><span style="color: black;"> |</span>
    <span id="filter-unread" class="status-option" style="cursor:pointer; padding: 0 6px; color: black;" onclick="filterPatients('UNREAD')">UNREAD</span>

</div>

   <div class="filter-box">
    <!-- ALL IMAGING Dropdown -->
    <div class="filter-item">
        <span class="filter-label" id="centerLabel">IMAGING</span>
        <i class="fa-solid fa-chevron-down"></i>

        <select id="centerSelect" onchange="updateCenterLabel()" class="hidden-select">
            <option value="ALL">IMAGING</option>
            {% for c in centers %}
                <option value="{{ c.name }}">{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- ALL RADS Dropdown -->
    <div class="filter-item">
        <span class="filter-label" id="radsLabel">RADS</span>
        <i class="fa-solid fa-chevron-down"></i>

        <select id="radsSelect" onchange="updateRadsLabel()" class="hidden-select">
            <option value="ALL">RADS</option>
            {% for r in rads %}
                <option value="{{ r.name }}">{{ r.name }}</option>
            {% endfor %}
        </select>
    </div>

   
    <!-- all assign -->
<div class="filter-item">
    <span class="filter-label" id="assignLabel"><i class="fa-solid fa-filter" style="font-size:14px; color:#007bff;"></i>
</span>
    <!-- <i class="fa-solid fa-chevron-down"></i> -->

    <select id="assignSelect" onchange="updateAssignLabel()" class="hidden-select">
        <option value="ALL"><i class="fa-solid fa-filter" style="font-size:14px; color:#242527;"></i></option>
        <option value="ASSIGNED">ASSIGNED</option>
        <option value="UNASSIGNED">UNASSIGNED</option>
    </select>
</div>

</div>

<script>
function updateCenterLabel() {
    let select = document.getElementById("centerSelect");
    let label = document.getElementById("centerLabel");
    label.textContent = select.options[select.selectedIndex].text;
}

function updateRadsLabel() {
    let select = document.getElementById("radsSelect");
    let label = document.getElementById("radsLabel");
    label.textContent = select.options[select.selectedIndex].text;
}
</script>

    <button style="padding: 6px; background-color: white; font-size:12px;box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); font-weight: 500;border: 1px solid #ccc; margin-left: 0px; margin-top: 0px;">
       <span class="scan-option" style=" " onclick="filterByScanType('ALL')">All</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('X-RAY')">X-RAY</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('CT')">CT</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MRI')">MRI</span> | 
       <span class="scan-option" style="cursor:pointer; padding: 0 6px;" onclick="filterByScanType('MG')">MG</span>
    </button>
<!-- <button onclick="exportSelectedToExcel()" style="background-color: #4CAF50; font-weight: 600; color: white;">
    E-xcel
</button> -->

    <!-- <a href="" style="background-color: aliceblue; padding: 3px; border-radius: 8px;">
        <i class="fa-solid fa-rotate-right"></i>
    </a> -->
<!-- 
   <div class="date-filter">
  <button id="dateFilterBtn"><i class="fas fa-calendar"></i></button>

  <input id="dateRangeInput" type="text" placeholder="Select date range" readonly
         style="margin-left:8px; display: none; padding:6px 10px; border-radius:4px; border:none; width:220px; font-size:14px;" />

  <div class="date-cycle">
  <button id="dateCycleBtn" style="margin-left:6px; padding:6px 10px; border-radius:5px; border:none; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px;">
    <i class="fas fa-arrow-left" onclick="changeDateFilter('left', event)"></i>
    <span id="dateCycleLabel">DATE</span>
    <i class="fas fa-arrow-right" onclick="changeDateFilter('right', event)"></i>
  </button>
</div> -->
<div class="date-chip-box" style="box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);">

    <span class="chip active" style="color: #007bff;" onclick="setDateFilter('ALL')">All</span>
    <span class="divider">|</span>

    <span style="color:#007bff ; font-weight: bold;" class="chip" onclick="goPrevDay()">&lt;&lt;</span>

    <span id="dayChip" class="chip" onclick="setDateFilter('TODAY')">TODAY</span>


    <span style="color:#007bff; font-weight: bold;" class="chip" onclick="goNextDay()">&gt;&gt;</span>

    <!-- <span class="divider">|</span> -->
    <span class="chip" onclick="setDateFilter('MONTH')">MONTH</span>

    <span class="calendar-icon" onclick="openDateRange()">
        <i class="fa-regular fa-calendar"></i>
        
    </span>
    
    
</div>
<div id="calendarContainer" style="display:none; margin-left: -500px; margin-top:5px; position:relative;">
    <div id="calendarBox" style="position:absolute; z-index:9999; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
        
        
        <input type="text" id="calendarInput" readonly 
               style="width:240px; padding:8px; border:1px solid #ccc; border-radius:6px; display: none;">

        <div id="litepickerInline" style="margin-top:8px;"></div>
    </div>
</div>

  <div style=" display: inline-block; box-shadow: 0 6px 12px rgba(0, 123, 255, 0.45); margin-left: 4px;">
    <input type="search" id="searchInput" placeholder="Search det..."
      style="margin-left: 0px; padding: 3px 35px 5px 10px; border-radius: 3px; border: 1px solid #ccc; width: 150px; font-size: 16px;">
  </div>
  <a href="" style="background-color: rgb(251, 250, 250);box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); border: 1px solid #ccc; color: #007bff;">
        <i class="fa-solid fa-search"></i>
    </a>
<!-- </div> -->


    <span id="refreshTimer" style="margin-left: 0px; font-weight: 300; color: white;">
    <span id="live-seconds" style="font-weight:bold; color:white;">30s</span>


</span>
<!-- <a href="" style="background-color: rgb(219, 234, 248); padding: 6px; margin-left: 90px; border-radius: 8px;">
        <i class="fa-solid fa-rotate-right"></i>
    </a> -->

</div>

  <!-- üîµ TOP TAB BAR WITH ICONS -->
<div id="patientTabs" style="
    position: fixed;
    top: 106px;
    left: 60px;
    right: 0;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 10px;
    background: #cbcaca;
    border-bottom: 1px solid #d7d7d7;
    z-index: 999;
">

    <!-- LEFT SIDE ‚Äì TABS -->
    <div id="tabContainer" style="display:flex; gap:6px; align-items:center;">
        <div class="tab-item tab-active" 
             onclick="window.location.href='/index/'"
             style="background:#1d6ede; color:white; font-weight:600;">
            PATIENT LIST
        </div>
    </div>

    <!-- RIGHT SIDE ‚Äì BULK ICONS -->
    <div id="bulkIcons" style="display:flex; gap:18px; align-items:center;">
        <i id="bulkEditIcon" class="fa-solid fa-pen-to-square" title="Edit"
            style="cursor:pointer; color:#0d47a1; opacity:0.4;" onclick="bulkEdit()"></i>

        <i id="bulkDeleteIcon" class="fa-solid fa-trash" title="Delete"
            style="cursor:pointer; color:red; opacity:0.4;" onclick="bulkDelete()"></i>

        <i id="bulkDownloadIcon" class="fa-solid fa-download" title="Download"
            style="cursor:pointer; color:green; opacity:0.4;" onclick="bulkDownload()"></i>

        <i id="bulkShareIcon" class="fa-solid fa-share-nodes" title="Share"
            style="cursor:pointer; color:#333; opacity:0.4;" onclick="bulkShare()"></i>

        <span id="selectedCount" style="font-size:12px; color:black;">0</span>
    </div>

</div>

</div>

<!-- </div> -->

<!-- ========================= ADD PATIENT POPUP ========================= -->

<!-- ===== POPUP OVERLAY ===== -->
<div id="patientPopupOverlay" onclick="if(event.target === this) closePatientPopup();" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
">
<div class="modal" onclick="event.stopPropagation();">
  <div class="modal-header">
    <h2>Patient Details</h2>

    <!-- CLOSE BUTTON -->
    <span onclick="closePatientPopup()" style="
      position:absolute;
      right:16px;
      top:8px;
      color:white;
      font-size:22px;
      cursor:pointer;">√ó</span>
  </div>

  <form class="patient-form" id="patientPopupForm">

    <div class="row">
      <div class="field">
        <label>Patient ID</label>
        <input id="pop_patientId" type="text" placeholder="Enter ID">
      </div>
      <div class="field">
        <label>Hospital</label>
        <select id="pop_hospitalSelect" style="width: 100%;">
            <option value="">Select Hospital</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Patient Name</label>
        <input id="pop_patientName" required style="width:158%;" type="text" placeholder="Full Name">
      </div>

      <div style="margin-left: 110px;" class="field">
        <label>Age</label>
        <input style="width: 50%;" required id="pop_age" inputmode="numeric" type="number" placeholder="Age">
      </div>

      <div style="margin-right: 0px;" class="field gender">
        <label>Gender</label>
        <div style="border: 1px solid #d1d8e3;" class="gender-box">
        <span style="" class="gender-btn active" data-gender="M">M</span>
        <span class="gender-btn" data-gender="F">F</span>
        <span class="gender-btn" data-gender="O">O</span>

        <input type="hidden" id="pop_gender">

        </div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="Modality">Modality</label>
        <select required style="width: 70%;" id="pop_scanType">
            <option value="X-RAY" selected>X-RAY</option>
            <option value="CT">CT</option>
            <option value="MRI">MRI</option>
            <option value="MG">MG</option>
        </select>
      </div>

      <div style="margin-left: -50px;" class="field">
        <label>Body Part</label>
        <input style="width: 87%;" required id="pop_bodyPart" type="text" placeholder="e.g. Chest">
      </div>

      <div style="margin-right: 120px;" class="field">
        <label> Clinical History</label>
        <input style="width: 165%;" id="pop_history" type="text" placeholder="Short history">
      </div>
    </div>

    <div class="row bottom-row">
      <div class="field">
        <label>Referred By</label>
        <input style="width: 92%;" id="pop_refBy" type="text" placeholder="Doctor name">
      </div>
      <label style="margin-right: 50px; margin-bottom: -13px; padding:6px;" class="upload-box">
        <input type="file" id="pop_uploadScan" required hidden accept="image/*" multiple>
        ‚¨Ü Upload Scan (Multiple)
      </label>

      <button style="padding: 10px 28px; margin-bottom: -12px;" class="submit-btn">Submit</button>
    </div>
    
    <!-- Selected Images Preview -->
    <div id="selectedImagesPreview" style="display:none; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:8px; margin-left:20px; margin-right:20px;">
        <div style="font-weight:600; margin-bottom:8px; color:#333;">Selected Images (Click to crop):</div>
        <div id="imagesList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>
    
<img id="pop_preview" style="display:none;">
<img id="pop_finalImage" style="display:none;">
<input type="hidden" id="pop_center" value="{{ request.session.user_name }}">

  </form>
</div>
</div>

<!-- ===== FULLSCREEN CROP EDITOR ===== -->
<div id="cropEditor" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    z-index:100000;
    align-items:center;
    justify-content:center;
">
    <div style="
        width:90%;
        max-width:700px;
        background:#ffffff;
        border-radius:12px;
        padding:16px;
        box-shadow:0 20px 50px rgba(0,0,0,0.4);
        display:flex;
        flex-direction:column;
    ">

        <!-- IMAGE PREVIEW AREA -->
        <div style="
            height:70vh;
            background:#000; /* solid black behind the image */
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
        ">
            <img id="cropImage" style="
                max-width:100%;
                max-height:100%;
                object-fit:contain;
            ">
        </div>

        <!-- ACTION BUTTONS -->
        <div style="
            display:flex;
            justify-content:center;
            gap:12px;
            margin-top:14px;
        ">
            <button onclick="closeCropper()" style="
                padding:8px 20px;
                border-radius:6px;
                border:1px solid #ccc;
                background:#f3f4f6;
                cursor:pointer;
                font-size:14px;
            ">
                Cancel
            </button>

            <button onclick="finishCrop()" style="
                padding:8px 22px;
                background:#28a745;
                color:white;
                border:none;
                border-radius:6px;
                font-size:14px;
                font-weight:600;
                cursor:pointer;
                box-shadow:0 4px 10px rgba(40,167,69,0.35);
            ">
                Done
            </button>
        </div>

    </div>
</div>

<div id="editModal" style="
    display:none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background:#f9fbff;
    padding: 18px;
    border-radius: 12px;
    width: 300px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    border: 1px solid #d0d7e0;
    z-index: 100000;
    font-family: Arial;
">
    <h3 style="
        margin-top:0;
        margin-bottom:12px;
        text-align:center;
        color:#0d47a1;
        font-size:18px;
    ">‚úèÔ∏è Edit Patient</h3>

    <!-- Close button -->
    <span onclick="document.getElementById('editModal').style.display='none'" style="
        position:absolute;
        right:12px;
        top:8px;
        font-size:20px;
        cursor:pointer;
        color:#555;
    ">√ó</span>

    <label class="edit-label">Name</label>
    <input id="editName" placeholder="Name" class="pop-input edit-input">

    <label class="edit-label">Age</label>
    <input id="editAge" placeholder="Age" class="pop-input edit-input">

    <label class="edit-label">Body Part</label>
    <input id="editBody" placeholder="Body Part" class="pop-input edit-input">

    <label class="edit-label">History</label>
    <input id="editHis" placeholder="History" class="pop-input edit-input">

    <label class="edit-label">Ref By</label>
    <input id="editRef" placeholder="Ref By" class="pop-input edit-input">

    <button onclick="saveEdit()" style="
        width:100%;
        background:#0d47a1;
        color:white;
        padding:10px;
        border:none;
        border-radius:8px;
        margin-top:12px;
        font-size:15px;
        cursor:pointer;
    ">Save</button>
</div>

<style>
.edit-input {
    width: 80%;
    padding: 5px 8px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: 1px solid #c3ccd5;
    background: #eef4ff;
    font-size: 14px;
    outline: none;
}
.sidebar-hidden ~ #patientTabs {
    left: 0 !important;
}

.edit-input:focus {
    border-color: #0d47a1;
    box-shadow: 0 0 3px rgba(13,71,161,0.4);
}

.edit-label {
    font-size: 13px;
    font-weight: bold;
    margin-bottom: 4px;
    display:block;
    color:#333;
}
</style>


<script>
    function bulkEdit() {
    const id = document.querySelector(".rowCheckbox:checked").value;

    fetch(`/api/patient/${id}/`)
    .then(r => r.json())
    .then(p => {
        document.getElementById("editName").value = p.name;
        document.getElementById("editAge").value = p.age;
        document.getElementById("editBody").value = p.body_part;
        document.getElementById("editHis").value = p.history;
        document.getElementById("editRef").value = p.ref_by;

        document.getElementById("editModal").style.display = "block";
    });
}

function saveEdit() {
    const id = document.querySelector(".rowCheckbox:checked").value;

    fetch(`/api/patient/${id}/edit/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
        body: JSON.stringify({
            name: document.getElementById("editName").value,
            age: document.getElementById("editAge").value,
            body_part: document.getElementById("editBody").value,
            history: document.getElementById("editHis").value,
            ref_by: document.getElementById("editRef").value,
        })
    }).then(r => r.json())
    .then(() => location.reload());
}

</script>

<div  id="nav3" class="nav3" class="max-h-[450px] overflow-y-auto border border-gray-300">
    <table class="min-w-full border-collapse" >
         <thead class="bg-white sticky top-0 z-10 border-b-2 border-gray-200">
      <tr>
        <th  class="p-2"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">Center/Date</th>
        <th class="p-2">Patient</th>
        <th class="p-2">Age/Sex</th>
        <th class="p-2">Scan Type</th>
        <th class="p-2">Body Part</th>
        <th class="p-2">History</th>
        <th class="p-2">Assign</th>
        <th class="p-2">Report</th>
        <th class="p-2">TAT</th>
        <th class="p-2">Amount</th>
      </tr>
    </thead>
        
        
        <tbody  id="patientTable">
            
            {% for patient in patients %}
            <tr data-entry-date="{{ patient.entry_time|date:'Y-m-d' }}"
            data-center="{{ patient.center }}" 
            data-rads="{% if patient.assigned_to %}{{ patient.assigned_to.name }}{% else %}NONE{% endif %}"
           onclick="handleRowClick('{{patient.id}}', '{{patient.name}}', event)"
 
                style="cursor:pointer; background-color: {% if patient.status == 'FINAL' %}#{% elif patient.status == 'DRAFT' %}#{% else %}#{% endif %}">
                
                <td>
                    
                    <input type="checkbox" value="{{ patient.id }}"  class="rowCheckbox" data-id="{{patient.id}}" onclick="event.stopPropagation()">

                    {{ patient.center }}<br>
                    <small>{{patient.entry_time|date:"d/m/Y"}} | {{patient.entry_time|time:"H:i"}}</small>
                </td>
                <td>
                    <strong>{{patient.name}}</strong><br>
                    <small>{{patient.patient_id}}</small>
                </td>
                <td>{{patient.age}}/{{patient.gender}}</td>
                <td>{{patient.scan_type}}</td>
                <td class="history-tooltip">
                    <strong>{{patient.body_part|upper}}</strong><br>
                    <small>{{patient.ref_by}}</small>
                </td>
                <td class="history-col">
                    <div class="history-tooltip">
                        {{ patient.history|truncatechars:35 }}
                        <div class="history-popup">
                            {{ patient.history }}
                        </div>
                    </div>
                </td>


              <td onclick="event.stopPropagation();">
    <select style="border: 1px solid rgb(214, 213, 213); border-radius: 5px;" class="assign-dropdown"
        data-patient="{{ patient.id }}"
        onchange="assignPatient('{{patient.id}}', this.value)">
    
    {% if patient.assigned_to %}
        <option value="UNASSIGN">select</option>
    {% else %}
        <option value="">Select</option>
    {% endif %}

    {% for r in rads %}
        <option value="{{r.id}}"
            {% if patient.assigned_to and patient.assigned_to.id == r.id %}selected{% endif %}>
            {{r.name}}
        </option>
    {% endfor %}
</select>

    <br>
    <small class="assigned-time">
{% if patient.assigned_time %}
    {{ patient.assigned_time|date:"d/m/Y" }} | {{ patient.assigned_time|time:"H:i" }}
{% else %}
    <!-- blank when not assigned -->
{% endif %}
</small>

    <!-- show currently assigned -->
    {% if patient.assigned_to %}
      <!-- <br><small class="assigned-to-display">{{ patient.assigned_to.name }}</small> -->
    {% else %}
      <br><small class="assigned-to-display"></small>
    {% endif %}
</td>
                <td>
                    <i class="fa-regular fa-file-pdf"
                    style="color:red; cursor:pointer; margin-right:8px;"
                    onclick="downloadReport({{patient.id}}, 'pdf', event)"></i>

                    <i class="fa-regular fa-file-word"
                    style="color:blue; cursor:pointer;"
                    onclick="downloadReport({{patient.id}}, 'word', event)"></i>

                    <span class="status {{patient.status|lower}}">
                        {{ patient.status }}
                    </span>

                    {% if patient.status == 'FINAL' and patient.final_time %}
                        <br>
                        <small style="color:#6b7280; font-size:11px;">
                            {{ patient.final_time|date:"d/m/Y" }} | {{ patient.final_time|time:"H:i" }}
                        </small>
                    {% endif %}
                </td>

                <!-- <td><span class="green-dot"></span></td> -->
   <td>
    {% if patient.tat %}
        <span style="color:green; font-weight:600;">
            {{ patient.tat }}
        </span>
    {% elif patient.assigned_time %}
        <span style="color:orange; font-weight:600;">
            Running
        </span>
    {% else %}
        -
    {% endif %}
</td>



                <td>‚Çπ100</td>
                <!-- <td>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" 
                       onclick="deletePatient(event, {{patient.id}})"></i>
                </td> -->
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

{% endblock %}
<!-- ===== FOOTER PAGINATION ===== -->
<div id="footerPagination">

    <!-- LEFT -->
    <div id="pageSummary"> 1 of 1</div>
    <span style="text-align:center; padding:10px 0; color:#666; font-size:14px;">Copyright ¬© 2025 MEDink</span>
        


    <!-- CENTER -->
    <div class="footer-center">
        
        <button onclick="prevPage()">¬´</button>
        <span id="displaySummary" class="display-mid">0 ‚Äì 0 of 0</span>
        <button  onclick="nextPage()">¬ª</button>
        <select style="padding: 3px; font-size: 11px;" id="rowsPerPageSelect" onchange="changeRowsPerPage(this.value)">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <!-- <option value="15">15</option>
            <option value="20">20</option> -->
        </select>
    </div>
    

    <!-- RIGHT -->
    <!-- <div id="displaySummary"> 0 ‚Äì 0 of 0</div> -->

</div>
<script>
let currentPage = 1;
let rowsPerPage = 25;

function changeRowsPerPage(value) {
    rowsPerPage = parseInt(value);
    currentPage = 1;
    paginateTable();
}

function paginateTable() {
    const rows = Array.from(document.querySelectorAll("#patientTable tr"))
        .filter(row => row.dataset.visible === "1");

    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;

    if (currentPage > totalPages) currentPage = totalPages;

    // hide all first
    document.querySelectorAll("#patientTable tr")
        .forEach(r => r.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = Math.min(start + rowsPerPage, totalRows);

    rows.slice(start, end).forEach(r => r.style.display = "");

    document.getElementById("pageSummary").innerText =
        ` ${currentPage} of ${totalPages}`;

    // document.getElementById("pageNumber").innerText = currentPage;

    document.getElementById("displaySummary").textContent =
    totalRows === 0
        ? "0 ‚Äì 0 of 0"
        : `${start + 1} ‚Äì ${end} of ${totalRows}`;

}


function nextPage() {
    currentPage++;
    paginateTable();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        paginateTable();
    }
}

window.addEventListener("load", () => {
    paginateTable();
});
</script>



<script>
// üîπ CENTER FILTER
document.getElementById("centerSelect").addEventListener("change", function () {
    const selected = this.value.toUpperCase();
    const rows = document.querySelectorAll("#patientTable tr");

    rows.forEach(row => {
        const rowCenter = (row.dataset.center || "").toUpperCase();

        if (selected === "ALL" || rowCenter === selected) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

const sidebar = document.querySelector('.sidebar2');
const toggleBtn = document.getElementById('toggleBtn');
const nav2 = document.getElementById('nav2');
const nav3 = document.getElementById('nav3');

toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('sidebar-hidden');


    const icon = toggleBtn.querySelector('i');

    if (sidebar.classList.contains('sidebar-hidden')) {
        // Sidebar hidden ‚Üí shift right
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');

        // Smooth shift
        nav2.style.marginLeft = "0px";
        nav3.style.marginLeft = "0px";

    } else {
        // Sidebar visible ‚Üí shift back
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');

        nav2.style.marginLeft = "0px";
        nav3.style.marginLeft = "0px";
    }
});

// filteration
let currentStatusFilter = 'ALL';
let currentScanFilter = 'ALL';



function filterByScanType(scanType) {

    currentScanFilter = scanType.toUpperCase();

    // üî• UI ACTIVE UPDATE
    updateScanActiveUI();

    applyFilters();
}

function updateScanActiveUI() {
    document.querySelectorAll(".scan-option").forEach(el => {
        el.classList.remove("active");
    });

    const activeEl = [...document.querySelectorAll(".scan-option")]
        .find(el => el.textContent.trim().toUpperCase() === currentScanFilter);

    if (activeEl) {
        activeEl.classList.add("active");
    }
}


function applyFilters() {
    const rows = document.querySelectorAll('#patientTable tr');
    const searchText = document.getElementById('searchInput').value.trim().toUpperCase();

    const today = dateOnly(new Date());
    const yesterday = dateOnly(new Date(new Date().setDate(today.getDate() - 1)));

    rows.forEach(row => {
        let show = true;

        /* ---------------- STATUS FILTER ---------------- */
        const rowStatus = row.querySelector('.status')?.textContent.trim().toUpperCase() || "";
        if (currentStatusFilter !== "ALL" && rowStatus !== currentStatusFilter)
            show = false;

        /* ---------------- SCAN FILTER ------------------ */
        const rowScan = row.querySelector("td:nth-child(4)")?.textContent.trim().toUpperCase() || "";
        if (currentScanFilter !== "ALL" && rowScan !== currentScanFilter)
            show = false;

        /* ---------------- SEARCH FILTER ---------------- */
        const name = row.querySelector("td:nth-child(2) strong")?.textContent.trim().toUpperCase() || "";
        const pid = row.querySelector("td:nth-child(2) small")?.textContent.trim().toUpperCase() || "";
        if (searchText && !name.includes(searchText) && !pid.includes(searchText))
            show = false;
        
        /* ---------------- ASSIGN FILTER ------------------ */
        const assignFilter = document.getElementById("assignSelect").value;

        const rowRads = (row.dataset.rads || "").toUpperCase();  
        const isAssigned = rowRads !== "" && rowRads !== "NONE";

        if (assignFilter === "ASSIGNED" && !isAssigned)
            show = false;

        if (assignFilter === "UNASSIGNED" && isAssigned)
            show = false;
    


        /* ---------------- DATE FILTER ------------------ */
        const dateText = row.querySelector("td small")?.textContent.split(" | ")[0]; // d/m/Y
        if (dateText) {
            const [d, m, y] = dateText.split("/");
            const rowDate = dateOnly(new Date(`${y}-${m}-${d}`));

            if (selectedDateFilter === "TODAY" && rowDate.getTime() !== today.getTime())
                show = false;

            if (selectedDateFilter === "DAY-JUMP" && rowDate.getTime() !== tempSelectedDay.getTime())
                show = false;

            if (selectedDateFilter === "MONTH") {
                let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                let monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                if (rowDate < monthStart || rowDate > monthEnd)
                    show = false;
            }
        }

     row.dataset.visible = show ? "1" : "0";
row.style.display = show ? "" : "none";
});

// üî• VERY IMPORTANT
currentPage = 1;
paginateTable();

}


// Add these functions to your existing script section

function downloadReport(id, type, event) {
    event.stopPropagation();
    fetch(`/api/patient/${id}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(patient => {
            console.log('Patient data:', patient); // For debugging
            if(patient.status !== 'FINAL') {
                alert('Report can only be downloaded for finalized reports');
                return;
            }
            
            if(type === 'pdf') {
                generatePDF(patient);
            } else if(type === 'word') {
                generateWord(patient);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error downloading report');
        });
}

// Function to strip HTML tags
function stripHtmlTags(html) {
    const tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
}

function generatePDF(patient) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Medical Letterhead Header
    doc.setFillColor(240, 248, 255); // Light blue background
    doc.rect(0, 0, 210, 35, 'F');

    // Medical Cross Symbol
    doc.setDrawColor(255, 0, 0); // Red color
    doc.setLineWidth(2);
    doc.line(15, 10, 25, 10); // Horizontal line
    doc.line(20, 5, 20, 20);  // Vertical line

    // Hospital Header
    doc.setFontSize(16);
    doc.setTextColor(0, 100, 0); // Dark green
    doc.text('MEDINK DIAGNOSTIC CENTER', 35, 15);

    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100); // Gray
    doc.text('Advanced Medical Imaging & Radiology Services', 35, 22);
    doc.text('Address: 123 Medical Plaza, City - 400001 | Phone: +91-1234567890', 35, 28);

    // Reset text color
    doc.setTextColor(0, 0, 0);

    // Patient Details Section (removed header text)

    // Draw single box for all patient details
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.8);
    doc.rect(15, 35, 175, 35); // Single big box for all details - moved up

    // Removed vertical divider line for cleaner look

    // Add patient details text inside the single box - Left Column
    doc.setFontSize(10);
    doc.text(`Patient ID: ${patient.patient_id}`, 20, 45);
    doc.text(`Name: ${patient.name}`, 20, 53);
    doc.text(`Age/Gender: ${patient.age}/${patient.gender}`, 20, 61);

    // Right Column
    doc.text(`Scan Type: ${patient.scan_type}`, 110, 45);
    doc.text(`Body Part: ${patient.body_part}`, 110, 53);
    doc.text(`Referred By: Dr. ${patient.ref_by}`, 110, 61);

    // Report Date and Time
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    const currentDate = new Date();
    const formattedDate = currentDate.toLocaleDateString() + ' ' + currentDate.toLocaleTimeString();
    doc.text(`Report Date: ${formattedDate}`, 130, 40);

    // Removed duplicate patient details section

    // Clinical Findings Section
    doc.setFontSize(12);
    doc.setTextColor(255, 0, 0); // Red for findings
    doc.text('CLINICAL FINDINGS', 20, 85);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);

    // Draw findings box
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.5);
    doc.rect(15, 90, 175, 70);

    const reportText = stripHtmlTags(patient.report) || 'No significant abnormalities detected.';
    const splitReport = doc.splitTextToSize(reportText, 165);
    doc.text(splitReport, 20, 100);

    // Doctor Signature Section
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Radiologist Signature: ___________________________', 20, 170);
    doc.text('Date: _______________', 130, 170);

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('This is a computer generated report. Please consult your physician for clinical interpretation.', 20, 180);

    // Medical disclaimer
    doc.setFontSize(7);
    doc.text('* This report is confidential and intended for medical professional use only.', 20, 185);

    doc.save(`MEDINK_Report_${patient.patient_id}.pdf`);
}

function generateWord(patient) {
    const { Document, Paragraph, TextRun, HeadingLevel, Packer, Table, TableCell, TableRow, WidthType, BorderStyle, AlignmentType } = docx;

    const currentDate = new Date();
    const formattedDate = currentDate.toLocaleDateString() + ' ' + currentDate.toLocaleTimeString();

    const doc = new Document({
        sections: [{
            properties: {},
            children: [
                // Header with medical center info
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "üè• MEDINK DIAGNOSTIC CENTER",
                            size: 32, // 16pt
                            bold: true,
                            color: "006400" // Dark green
                        })
                    ],
                    alignment: AlignmentType.CENTER
                }),
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "Advanced Medical Imaging & Radiology Services",
                            size: 20, // 10pt
                            color: "666666"
                        })
                    ],
                    alignment: AlignmentType.CENTER
                }),
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "Address: 123 Medical Plaza, City - 400001 | Phone: +91-1234567890",
                            size: 18, // 9pt
                            color: "666666"
                        })
                    ],
                    alignment: AlignmentType.CENTER
                }),

                // Report title
                new Paragraph({
                    text: "RADIOLOGY REPORT",
                    heading: HeadingLevel.HEADING_1,
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 200 }
                }),

                // Date
                new Paragraph({
                    children: [
                        new TextRun({
                            text: `Report Date: ${formattedDate}`,
                            size: 20,
                            color: "666666"
                        })
                    ],
                    alignment: AlignmentType.RIGHT
                }),
                // Patient Information Section
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "PATIENT INFORMATION",
                            size: 24, // 12pt
                            bold: true,
                            color: "000080" // Navy blue
                        })
                    ],
                    spacing: { before: 200, after: 100 }
                }),
                // Create table for patient details
                new Table({
                    width: {
                        size: 100,
                        type: WidthType.PERCENTAGE,
                    },
                    borders: {
                        top: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                        bottom: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                        left: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                        right: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                        insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                        insideVertical: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                    },
                    rows: [
                        new TableRow({
                            height: { value: 300, rule: "exact" },
                            children: [
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Patient ID: ${patient.patient_id}`,
                                            bold: true,
                                            size: 20
                                        })]
                                    })]
                                }),
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Scan Type: ${patient.scan_type}`,
                                            bold: true,
                                            size: 20
                                        })]
                                    })]
                                })
                            ]
                        }),
                        new TableRow({
                            height: { value: 300, rule: "exact" },
                            children: [
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Name: ${patient.name}`,
                                            size: 20
                                        })]
                                    })]
                                }),
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Body Part: ${patient.body_part}`,
                                            size: 20
                                        })]
                                    })]
                                })
                            ]
                        }),
                        new TableRow({
                            height: { value: 300, rule: "exact" },
                            children: [
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Age/Gender: ${patient.age}/${patient.gender}`,
                                            size: 20
                                        })]
                                    })]
                                }),
                                new TableCell({
                                    width: { size: 45, type: WidthType.PERCENTAGE },
                                    margins: { top: 100, bottom: 100, left: 200, right: 200 },
                                    children: [new Paragraph({
                                        spacing: { after: 100 },
                                        children: [new TextRun({
                                            text: `Referred By: Dr. ${patient.ref_by}`,
                                            size: 20
                                        })]
                                    })]
                                })
                            ]
                        })
                    ]
                }),
                // Clinical Findings Section
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "CLINICAL FINDINGS",
                            size: 24, // 12pt
                            bold: true,
                            color: "FF0000" // Red
                        })
                    ],
                    spacing: { before: 300, after: 100 }
                }),

                new Paragraph({
                    children: [new TextRun({
                        text: stripHtmlTags(patient.report) || 'No significant abnormalities detected.',
                        size: 22 // 11pt
                    })],
                    spacing: { before: 200, after: 400 }
                }),

                // Signature Section
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "Radiologist Signature: ___________________________",
                            size: 20
                        })
                    ],
                    spacing: { before: 500, after: 200 }
                }),

                new Paragraph({
                    children: [
                        new TextRun({
                            text: "Date: _______________",
                            size: 20
                        })
                    ],
                    alignment: AlignmentType.RIGHT,
                    spacing: { before: 100, after: 300 }
                }),

                // Footer disclaimer
                new Paragraph({
                    children: [
                        new TextRun({
                            text: "This is a computer generated report. Please consult your physician for clinical interpretation.",
                            size: 16, // 8pt
                            color: "666666"
                        })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 400, after: 150 }
                }),

                new Paragraph({
                    children: [
                        new TextRun({
                            text: "* This report is confidential and intended for medical professional use only.",
                            size: 14, // 7pt
                            color: "666666"
                        })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 100 }
                })
            ]
        }]
    });

    Packer.toBlob(doc).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MEDINK_Report_${patient.patient_id}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
}

function exportSelectedToExcel() {
    const selectedCheckboxes = document.querySelectorAll('.rowCheckbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one patient to export');
        return;
    }

    const data = [];
    const headers = ['Patient ID', 'Name', 'Age/Gender', 'Scan Type', 'Body Part', 'History', 'Referred By', 'Status'];
    
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const rowData = {
            'Patient ID': row.querySelector('td:nth-child(2) small').textContent,
            'Name': row.querySelector('td:nth-child(2) strong').textContent,
            'Age/Gender': row.querySelector('td:nth-child(3)').textContent,
            'Scan Type': row.querySelector('td:nth-child(4)').textContent,
            'Body Part': row.querySelector('td:nth-child(5) strong').textContent,
            'History': row.querySelector('td:nth-child(6)').textContent,
            'Referred By': row.querySelector('td:nth-child(7)').textContent,
            'Status': row.querySelector('.status').textContent
        };
        data.push(rowData);
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Patients");
    XLSX.writeFile(wb, "selected_patients.xlsx");
}

function toggleSelectAll(checkbox) {
    const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
    rowCheckboxes.forEach(cb => cb.checked = checkbox.checked);
}


// üü¢ SEARCH + FILTER COMBINED
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('keyup', applyFilters);




const centerSelect = document.getElementById("centerSelect");
centerSelect.addEventListener("change", function() {
    const selectedCenter = this.value.toUpperCase();
    const rows = document.querySelectorAll("#patientTable tbody tr");

    rows.forEach(row => {
        const center = row.getAttribute("data-center")?.toUpperCase() || '';
        if (selectedCenter === "ALL" || center === selectedCenter) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

document.getElementById("radsSelect").addEventListener("change", function () {
    const selected = this.value.toUpperCase();
    const rows = document.querySelectorAll("#patientTable tr");

    rows.forEach(row => {
        const rowRads = (row.dataset.rads || "").toUpperCase();

        if (selected === "ALL" || rowRads === selected) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});


// all RADS assign-dropdown
function assignPatient(patientId, radId) {

    fetch(`/assign_patient/${patientId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
            rad_id: radId === "UNASSIGN" ? null : radId
        })
    })
    .then(response => {
        if (response.ok) {
            location.reload(); // simple & safe
        } else {
            alert("Action failed!");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error assigning/unassigning");
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// function assignPatient(patientId, radId) {
//     // radId can be empty string for unassign
//     fetch(`/assign_patient/${patientId}/`, {
//         method: "POST",
//         headers: {
//             "Content-Type": "application/json",
//             // If you removed @csrf_exempt above, uncomment CSRF header:
//             "X-CSRFToken": getCookie("csrftoken")
//         },
//         body: JSON.stringify({ rad_id: radId })
//     })
//     .then(res => res.json())
//     .then(data => {
//         if (data.success) {
//             // Update UI: show assigned name below the dropdown
//             const dropdown = document.querySelector(`select.assign-dropdown[data-patient="${patientId}"]`);
//             if (dropdown) {
//                 // find/create assigned display element
//                 let small = dropdown.parentElement.querySelector('.assigned-to-display');
//                 if (!small) {
//                     small = document.createElement('small');
//                     small.className = 'assigned-to-display';
//                     dropdown.parentElement.appendChild(document.createElement('br'));
//                     dropdown.parentElement.appendChild(small);
//                 }
//                 small.textContent = data.assigned_to ? data.assigned_to.name : '';
//             }
//             alert("Assigned successfully‚úÖ");
//         } else {
//             alert("Assign failed: " + (data.error || 'Unknown'));
//         }
//     })
//     .catch(err => {
//         console.error(err);
//         alert("Error assigning");
//     });
// }

// ‚úÖ Auto-refresh countdown + refresh
document.addEventListener("DOMContentLoaded", function() {
    let countdown = 30; // 30 seconds timer
    const timerDisplay = document.getElementById("live-seconds");

   function updateTimer() {
        if (!timerDisplay) return;

        // Change color based on remaining seconds
        if (countdown > 10) {
            timerDisplay.style.color = "blue"; // normal
        } else if (countdown > 5) {
            timerDisplay.style.color = "orange"; // warning
        } else {
            timerDisplay.style.color = "red"; // danger
        }

        timerDisplay.textContent = countdown + "s";
        countdown--;

        if (countdown < 0) {
            countdown = 30; // reset timer
            refreshTbody(); // refresh tbody data
        }
    }

    // tbody refresh function
    function refreshTbody() {
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const newTbody = doc.querySelector("tbody");
            const oldTbody = document.querySelector("tbody");

            if (newTbody && oldTbody) {
                oldTbody.innerHTML = newTbody.innerHTML;

                // ‚≠ê Refresh ‡§ï‡•á ‡§¨‡§æ‡§¶ filter ‡§´‡§ø‡§∞ ‡§∏‡•á apply ‡§ï‡§∞‡•ã
                applyFilters();
            }
        })
        .catch(err => console.error("Error refreshing tbody:", err));
}


    // timer update every 1 second
    setInterval(updateTimer, 1000);
});



function filterPatients(status) {
  currentStatusFilter = status.toUpperCase();
  applyFilters();

  // Highlight selected filter
  document.querySelectorAll('#statusFilter span').forEach(el => el.classList.remove('active'));
  const activeEl = document.querySelector(`#filter-${status.toLowerCase()}`);
  if (activeEl) activeEl.classList.add('active');
}

// üåó LIGHT / DARK MODE SWITCH
const toggle = document.getElementById("themeToggle");

// Load saved mode
if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    toggle.checked = true;
}

// Toggle event
toggle.addEventListener("change", () => {
    if (toggle.checked) {
        document.body.classList.add("dark-mode");
        localStorage.setItem("theme", "dark");
    } else {
        document.body.classList.remove("dark-mode");
        localStorage.setItem("theme", "light");
    }
});

</script>

<script>
// ======= Helper: CSRF getter =======
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ======= DOM ready =======
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('patientTable');
    // const bulkBar = document.getElementById('bulkActionBar');
    const selectedCountEl = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');

    function getSelectedCheckboxes() {
        return Array.from(document.querySelectorAll('.rowCheckbox')).filter(chk => chk.checked);
    }

    // function updateBulkBar() {
    //     const selected = getSelectedCheckboxes();
    //     if (selected.length > 0) {
    //         bulkBar.style.display = 'flex';
    //         selectedCountEl.innerText = `${selected.length} Selected`;
    //     } else {
    //         bulkBar.style.display = 'none';
    //         selectedCountEl.innerText = `0 Selected`;
    //     }
    // }

    // Event delegation for checkboxes (works even if tbody is refreshed dynamically)
    // tableBody.addEventListener('change', function(e) {
    //     const target = e.target;
    //     if (target.classList && target.classList.contains('rowCheckbox')) {
    //         e.stopPropagation(); // avoid row click navigation
    //         updateBulkBar();
    //     }
    // });

    // selectAll checkbox behaviour
    selectAll.addEventListener('change', function() {
        const all = document.querySelectorAll('.rowCheckbox');
        all.forEach(cb => cb.checked = selectAll.checked);
        updateBulkIcons();
    });

    // If rows are refreshed dynamically elsewhere, call updateBulkBar() after refresh
    // e.g., after replacing tbody innerHTML call updateBulkBar();

    // ======= Bulk actions =======
    window.bulkDelete = function() {
        const ids = getSelectedCheckboxes().map(cb => cb.value);
        if (ids.length === 0) return alert('Select at least one row.');
        if (!confirm(`Delete ${ids.length} selected?`)) return;

        fetch('/api/delete-multiple/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ids })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // remove deleted rows from DOM (faster than reload)
                ids.forEach(id => {
                    const cb = document.querySelector(`.rowCheckbox[value="${id}"]`);
                    if (cb) cb.closest('tr').remove();
                });
                updateBulkBar();
                alert('Deleted successfully');
            } else {
                alert('Delete failed');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Delete error');
        });
    };

    window.bulkDownload = function() {
        const ids = getSelectedCheckboxes().map(cb => cb.value);
        if (ids.length === 0) return alert('Select at least one row.');

        // open each report in new tab (browser may block many tabs) ‚Äî alternative: zip backend
        ids.forEach(id => window.open(`/download/${id}/pdf/`, '_blank'));
    };

    window.bulkShare = function() {
        const ids = getSelectedCheckboxes().map(cb => cb.value);
        if (ids.length === 0) return alert('Select at least one row.');

        // For now show message ‚Äî implement WhatsApp/API integration server-side later
        alert(`Prepare to share ${ids.length} reports. Implement WhatsApp API on backend to send messages.`);
    };

    // EDIT: open modal for first selected (you can extend for multi-edit)
    window.bulkEdit = function() {
        const selected = getSelectedCheckboxes();
        if (selected.length === 0) return alert('Select one row to edit.');
        const id = selected[0].value;

        fetch(`/api/patient/${id}/`)
        .then(r => {
            if (!r.ok) throw new Error('Failed to fetch patient');
            return r.json();
        })
        .then(p => {
            document.getElementById("editName").value = p.name || '';
            document.getElementById("editAge").value = p.age || '';
            document.getElementById("editBody").value = p.body_part || '';
            document.getElementById("editHis").value = p.history || '';
            document.getElementById("editRef").value = p.ref_by || '';

            document.getElementById("editModal").dataset.editingId = id;
            document.getElementById("editModal").style.display = 'block';
        })
        .catch(err => {
            console.error(err);
            alert('Could not load patient for edit');
        });
    };

    // saveEdit (hooked to Save button)
    window.saveEdit = function() {
        const modal = document.getElementById('editModal');
        const id = modal.dataset.editingId;
        if (!id) return alert('No patient id');

        const payload = {
            name: document.getElementById("editName").value,
            age: document.getElementById("editAge").value,
            body_part: document.getElementById("editBody").value,
            history: document.getElementById("editHis").value,
            ref_by: document.getElementById("editRef").value
        };

        fetch(`/api/patient/${id}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // optional: update row UI in-place (or reload)
                location.reload();
            } else {
                alert('Edit failed');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Edit error');
        });
    };

    // modal close on outside click or Escape
    document.addEventListener('click', function(e){
        const modal = document.getElementById('editModal');
        if (modal.style.display === 'block' && !modal.contains(e.target) && !e.target.classList.contains('action-btn')) {
            modal.style.display = 'none';
        }
    });
    document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
            document.getElementById('editModal').style.display = 'none';
        }
    });

}); // DOMContentLoaded end

// Handle row clicks for both desktop and mobile
let clickCount = 0;
let clickTimer = null;

function handleRowClick(patientId, patientName, event) {
    // Prevent default behavior
    event.preventDefault();
    event.stopPropagation();

    // Check if mobile device
    const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    if (isMobile) {
        // On mobile, single click opens report
        openReportWithTab(patientId, patientName);
    } else {
        // On desktop, implement double-click behavior
        clickCount++;

        if (clickCount === 1) {
            clickTimer = setTimeout(() => {
                clickCount = 0;
                // Single click - do nothing special
            }, 300); // 300ms delay for double-click detection
        } else if (clickCount === 2) {
            clearTimeout(clickTimer);
            clickCount = 0;
            openReportWithTab(patientId, patientName);
        }
    }
}

function openReportWithTab(patientId, patientName) {
    let tabBar = document.getElementById("tabContainer");

    let tabId = "tab-" + patientId;

    // If already exists ‚Üí just redirect
    if (document.getElementById(tabId)) {
        window.location.href = `/report/${patientId}/`;
        return;
    }

    // Create new tab
    let tab = document.createElement("div");
    tab.id = tabId;
    tab.style.cssText = `
        padding: 3px 4px;
        background:#e8f2ff;
        border-radius: 6px;
        font-size: 12px;
        color:#003f7f;
        display:flex;
        align-items:center;
        gap:6px;
        cursor:pointer;
        border:1px solid #d0e3ff;
        height: 14px;
    `;

    tab.innerHTML = `
        <span>${patientName}</span>
        <span style="cursor:pointer; font-weight:bold;" 
              onclick="event.stopPropagation(); this.parentElement.remove();">√ó</span>
    `;

    tab.onclick = function () {
        window.location.href = `/report/${patientId}/`;
    };

    tabBar.appendChild(tab);

    // open report
    window.location.href = `/report/${patientId}/`;
}
function updateBulkIcons() {
    let selected = document.querySelectorAll('.rowCheckbox:checked').length;
    document.getElementById("selectedCount").innerText = selected + " Selected";

    let icons = [
        bulkEditIcon,
        bulkDeleteIcon,
        bulkDownloadIcon,
        bulkShareIcon
    ];

    icons.forEach(icon => {
        if (selected > 0) {
            icon.style.opacity = "1";
            icon.style.pointerEvents = "auto";
        } else {
            icon.style.opacity = "0.4";
            icon.style.pointerEvents = "none";
        }
    });
}


// checkbox event
// document.getElementById("patientTable").addEventListener("change", function(e){
//     if(e.target.classList.contains("rowCheckbox")){
//         updateBulkIcons();
//     }
// });
// ENABLE BULK ICONS WHEN ROW CHECKBOX CLICKED
document.getElementById("patientTable").addEventListener("change", function(e){
    if (e.target.classList.contains("rowCheckbox")) {
        updateBulkIcons();
    }
});

// ALSO UPDATE WHEN SELECT ALL CLICKED
document.getElementById("selectAll").addEventListener("change", function(){
    const all = document.querySelectorAll('.rowCheckbox');
    all.forEach(cb => cb.checked = this.checked);
    updateBulkIcons();
});

// datae range
let selectedDateFilter = "ALL";
let dayOffset = 0;   // 0 = today, 1 = yesterday ... max 7
let tempSelectedDay = dateOnly(new Date());

function dateOnly(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function getDateByOffset(offset) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return dateOnly(d);
}
function setDateFilter(type) {

    const allChips = document.querySelectorAll(".date-chip-box .chip");
    const dayChip = document.getElementById("dayChip");

    // üî• remove active from all
    allChips.forEach(c => c.classList.remove("active"));

    /* ===== ALL ===== */
    if (type === "ALL") {
        selectedDateFilter = "ALL";
        dayOffset = 0;

        // üî• ALL chip ko active banao
        allChips[0].classList.add("active"); // first chip = ALL

        applyFilters();
        return;
    }

    /* ===== TODAY ===== */
    if (type === "TODAY") {
        selectedDateFilter = "TODAY";
        dayOffset = 0;
        tempSelectedDay = getDateByOffset(0);

        dayChip.textContent = "TODAY";
        dayChip.classList.add("active");

        applyFilters();
        return;
    }

    /* ===== MONTH ===== */
    if (type === "MONTH") {
        selectedDateFilter = "MONTH";
        event.target.classList.add("active");

        applyFilters();
        return;
    }
}


function formatChipDate(dateObj) {
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    const d = dateObj.getDate();
    const m = months[dateObj.getMonth()];
    return `${d}-${m}`;
}

function getDateByOffset(offset) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return dateOnly(d);
}

function goPrevDay() {

    if (dayOffset >= 7) return;   // max last 7 days

    dayOffset++;
    tempSelectedDay = getDateByOffset(dayOffset);
    selectedDateFilter = "DAY-JUMP";

    const chip = document.getElementById("dayChip");

    if (dayOffset === 1) {
        chip.textContent = "Y-DAY";          // ‚úÖ exactly yesterday
    } else {
        chip.textContent = formatChipDate(tempSelectedDay); // ‚úÖ date start
    }

    document.querySelectorAll(".date-chip-box .chip")
        .forEach(c => c.classList.remove("active"));

    chip.classList.add("active");

    applyFilters();
}



function goNextDay() {

    if (dayOffset <= 0) return;   // future not allowed

    dayOffset--;
    tempSelectedDay = getDateByOffset(dayOffset);

    const chip = document.getElementById("dayChip");

    if (dayOffset === 0) {
        chip.textContent = "TODAY";
        selectedDateFilter = "TODAY";
    } 
    else if (dayOffset === 1) {
        chip.textContent = "Y-DAY";
        selectedDateFilter = "DAY-JUMP";
    } 
    else {
        chip.textContent = formatChipDate(tempSelectedDay);
        selectedDateFilter = "DAY-JUMP";
    }

    document.querySelectorAll(".date-chip-box .chip")
        .forEach(c => c.classList.remove("active"));

    chip.classList.add("active");

    applyFilters();
}
window.onload = function () {

    dayOffset = 0;
    selectedDateFilter = "TODAY";
    tempSelectedDay = getDateByOffset(0);

    const chip = document.getElementById("dayChip");
    chip.textContent = "TODAY";
    chip.classList.add("active");

    filterPatients("ALL");
    filterByScanType("ALL");
    applyFilters();
    updateScanActiveUI();   // üî• scan filter active wapas lao

};



function openDateRange() {
    const box = document.getElementById("calendarContainer");
    box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}
function closeCalendar() {
    document.getElementById("calendarContainer").style.display = "none";
}

let selectedStart = null;
let selectedEnd = null;

const picker = new Litepicker({
    element: document.getElementById('calendarInput'),
    inlineMode: true,
    container: document.getElementById('litepickerInline'),
    singleMode: false,
    numberOfMonths: 1,
    numberOfColumns: 1,
    format: 'YYYY-MM-DD',
    autoApply: true, // autoApply off because we'll manually apply when both dates selected
    setup: (pickerInstance) => {
        pickerInstance.on('selected', (start, end) => {
            // start or end are Luxon-like objects from Litepicker; get native Date:
            selectedStart = start ? start.dateInstance : null;
            selectedEnd = end ? end.dateInstance : null;

            if (selectedStart && selectedEnd) {
                // update visible input (optional)
                document.getElementById('calendarInput').value =
                    pickerInstance.getStartDate('YYYY-MM-DD') + " ‚Üí " +
                    pickerInstance.getEndDate('YYYY-MM-DD');

                // set global range vars used by applyFilters()
                startDate = selectedStart;
                endDate = selectedEnd;
                selectedDateFilter = "RANGE";

                // close the calendar UI
                closeCalendar();

                // apply filters immediately
                applyFilters();
            }
        });

        // optional: if user clears selection, reset variables
        pickerInstance.on('clear', () => {
            selectedStart = null;
            selectedEnd = null;
            startDate = null;
            endDate = null;
            selectedDateFilter = "ALL";
            document.getElementById('calendarInput').value = '';
            applyFilters();
        });
    }
});


function applyDateRange() {
    if (!selectedStart || !selectedEnd) {
        alert("Please select a valid range.");
        return;
    }

    startDate = selectedStart;
    endDate = selectedEnd;
    selectedDateFilter = "RANGE";

    closeCalendar();
    applyFilters();
}
function updateAssignLabel() {
    let select = document.getElementById("assignSelect");
    let label = document.getElementById("assignLabel");
    label.textContent = select.options[select.selectedIndex].text;
    applyFilters();   // ‚≠ê Change ‡§π‡•ã‡§§‡•á ‡§π‡•Ä filter ‡§ö‡§≤‡•á‡§ó‡§æ
}

// ========== PATIENT POPUP MODAL FUNCTIONS ==========
let cropper;
// Multiple images array
let selectedImages = [];
let currentCropIndex = -1;

/* OPEN / CLOSE POPUP */
function openPatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "flex";
    // Reset form
    document.getElementById("patientPopupForm").reset();
    // Set defaults
    document.getElementById("pop_gender").value = "M";
    document.getElementById("pop_scanType").value = "X-RAY";
    // Set gender button active state
    document.querySelectorAll("#patientPopupForm .gender-btn").forEach((btn, idx) => {
        btn.classList.remove("active");
        if (idx === 0) btn.classList.add("active"); // First button (M) is active
    });
    // Reset images
    selectedImages = [];
    currentCropIndex = -1;
    document.getElementById("selectedImagesPreview").style.display = "none";
    document.getElementById("imagesList").innerHTML = "";
    document.getElementById("pop_uploadScan").value = "";
    
    // Load hospitals
    loadHospitals();
}

function closePatientPopup() {
    document.getElementById("patientPopupOverlay").style.display = "none";
}

/* LOAD HOSPITALS */
function loadHospitals() {
    fetch("/api/admin/hospitals/")
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                const select = document.getElementById("pop_hospitalSelect");
                select.innerHTML = '<option value="">Select Hospital</option>';
                data.hospitals.forEach(h => {
                    const option = document.createElement("option");
                    option.value = h.id;
                    option.textContent = h.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(err => {
            console.error("Hospital load error:", err);
        });
}

/* AUTO PATIENT ID */
function newPatientId() {
    let d = new Date();
    return `P${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.floor(1000+Math.random()*9000)}`;
}

/* GENDER */
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll("#patientPopupForm .gender-btn").forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll("#patientPopupForm .gender-btn").forEach(x => x.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById("pop_gender").value = btn.dataset.gender;
        };
    });
});

/* IMAGE UPLOAD - MULTIPLE */
document.addEventListener('DOMContentLoaded', function() {
    const uploadInput = document.getElementById("pop_uploadScan");
    if (uploadInput) {
        uploadInput.addEventListener("change", function () {
            const files = Array.from(this.files);
            if (files.length === 0) return;

            // Show preview container
            document.getElementById("selectedImagesPreview").style.display = "block";
            const imagesList = document.getElementById("imagesList");
            imagesList.innerHTML = "";

            // Process each file
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Add to array
                    const imageIndex = selectedImages.length;
                    const imageData = {
                        index: imageIndex,
                        base64: e.target.result,
                        cropped: null
                    };
                    selectedImages.push(imageData);

                    // Create thumbnail preview
                    const thumbDiv = document.createElement("div");
                    thumbDiv.style.cssText = "position:relative; width:80px; height:80px; border:2px solid #ddd; border-radius:6px; overflow:hidden; cursor:pointer; background:#fff;";
                    thumbDiv.setAttribute('data-image-index', imageIndex);
                    thumbDiv.innerHTML = `
                        <img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">
                        <div style="position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600;">${imageIndex + 1}</div>
                    `;

                    // Click to crop this image
                    thumbDiv.onclick = () => {
                        currentCropIndex = parseInt(thumbDiv.getAttribute('data-image-index'));
                        document.getElementById("cropImage").src = e.target.result;
                        document.getElementById("cropEditor").style.display = "flex";
                        
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(document.getElementById("cropImage"), {
                            viewMode: 1,
                            autoCropArea: 1,
                            guides: false,        // Hide grid lines
                            center: false,        // Hide center indicator
                            highlight: false,     // Don't highlight crop area
                            background: false,    // Remove background
                            modal: false,         // Remove modal overlay
                            responsive: true,
                            restore: true,
                            checkCrossOrigin: false,
                            checkOrientation: false,
                            scalable: true,
                            zoomable: true,
                            zoomOnTouch: true,
                            zoomOnWheel: true,
                            wheelZoomRatio: 0.1,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                            toggleDragModeOnDblclick: false
                        });
                    };
                    
                    imagesList.appendChild(thumbDiv);
                };
                reader.readAsDataURL(file);
            });
        });
    }
});

/* CROP DONE - Update specific image */
function finishCrop() {
    if (currentCropIndex === -1 || !cropper) return;
    
    const canvas = cropper.getCroppedCanvas();
    const base64 = canvas.toDataURL("image/jpeg", 0.7);
    
    // Update the specific image in array
    selectedImages[currentCropIndex].cropped = base64;
    selectedImages[currentCropIndex].base64 = base64;
    
    // Update thumbnail
    const thumbs = document.querySelectorAll("#imagesList > div");
    if (thumbs[currentCropIndex]) {
        thumbs[currentCropIndex].querySelector("img").src = base64;
    }
    
    document.getElementById("cropEditor").style.display = "none";
    currentCropIndex = -1;
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

/* CLOSE CROPPER */
function closeCropper() {
    document.getElementById("cropEditor").style.display = "none";
    currentCropIndex = -1;
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

/* SUBMIT - Send multiple images */
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById("patientPopupForm");
    if (form) {
        form.addEventListener("submit", function(e){
            e.preventDefault();

            if (selectedImages.length === 0) {
                alert("Please select at least one image");
                return;
            }

            let pid = document.getElementById("pop_patientId").value.trim();
            if (!pid) pid = newPatientId();

            // Get all images (use cropped if available, else original)
            const imagesArray = selectedImages.map(img => {
                const imgData = img.cropped || img.base64;
                // Remove data:image prefix if present
                if (imgData.includes(',')) {
                    return imgData.split(',')[1];
                }
                return imgData;
            });

            const data = {
                patient_id: pid,
                name: document.getElementById("pop_patientName").value,
                age: document.getElementById("pop_age").value,
                gender: document.getElementById("pop_gender").value,
                history: document.getElementById("pop_history").value,
                scanType: document.getElementById("pop_scanType").value,
                bodyPart: document.getElementById("pop_bodyPart").value,
                refBy: document.getElementById("pop_refBy").value,
                scan: imagesArray,  // Send array instead of single image
                center: document.getElementById("pop_center").value,
                hospital_id: document.getElementById("pop_hospitalSelect").value // Hospital field
            };

            fetch("/api/patient/add/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === "success") {
                    closePatientPopup();
                    location.reload();
                } else {
                    alert(res.message || "Error submitting form");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error submitting form!");
            });
        });
    }
});

</script>
</body>
</html>