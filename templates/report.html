<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Report</title>

<!-- LIB FILES -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>

:root {
    --blue: #1a7bff;
    --light-bg: #f4f7fb;
    --text-dark: #2a2a2a;
}

/* GLOBAL */
body {
    margin: 0;
    background: black;
    font-family: "Segoe UI", Arial;
    overflow: hidden;
}

/* ――――― TOP HEADER ――――― */
.header {
    background: #ffffff;
    padding: 10px 15px;
    margin-top: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    border-bottom: 1px solid #d5e1ef;
    font-size: 14px;
}

.h-item { color: #3b3b3b; font-weight: 600; }
.h-value { color: var(--blue); font-weight: 700; }

/* ――――― TABS ――――― */
#patientTabs {
    background: #ffffff;
    border-bottom: 1px solid #d5ddea;
    padding: 5px 10px;
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    gap: 6px;
    z-index: 5000;
    height: 22px;
}

.tab-item {
    padding: 3px 10px;
    font-size: 12px;
    background: #eaf1ff;
    border-radius: 4px;
    border: 1px solid #c7d8f5;
    cursor: pointer;
}

.tab-active {
    background: var(--blue);
    color: white;
    border-color: #1055b6;
}

/* ――――― MAIN LAYOUT ――――― */
.main {
    display: flex;
    height: calc(100vh - 82px);
    width: 100%;
}

/* LEFT PANEL - PACS VIEWER */
.left-panel {
    width: 50%;
    background: black !important;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

#xrayImage {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    background: black !important;
}

/* Fix cropper BG always black */
.cropper-container,
.cropper-wrap-box,
.cropper-canvas,
.cropper-view-box {
    background-color: black !important;
}

/* ――――― ZOOM BAR ――――― */
.zoom-bar {
    position: absolute;
    bottom: 15px;
    display: flex;
    gap: 14px;
    padding: 10px 20px;
    background: rgba(0,0,0,0.55);
    border-radius: 40px;
    backdrop-filter: blur(4px);
}

.zoom-btn {
    font-size: 18px;
    color: white;
    cursor: pointer;
    transition: 0.2s;
}
.zoom-btn:hover {
    color: var(--blue);
    transform: scale(1.2);
}

/* ――――― RIGHT PANEL ――――― */
.right-panel {
    width: 50%;
    background: var(--light-bg);
    padding: 15px;
    overflow-y: auto;
}

.editor-box {
    background: white;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #e1e6f0;
}

/* MS Word-like Quill styles */
.ql-toolbar {
    border: 1px solid #ccc;
    border-bottom: none;
    background: #f8f8f8;
    border-radius: 10px 10px 0 0;
}
.ql-container {
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 10px 10px;
}
.ql-editor {
    font-family: 'Calibri', sans-serif;
    font-size: 11pt;
    line-height: 1.15;
    padding: 12px 15px;
    min-height: 400px;
}

/* Report buttons */
.report-btn {
    background: white;
    color: #333;
    border: 1px solid #ccc;
    transition: all 0.3s ease;
}
.report-btn.active {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

/* BUTTONS */
.btn-row {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
}

.btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

.btn-draft {
    background: #ffe9b8;
    color: #745200;
}

.btn-submit {
    background: #28a745;
    color: white;
}

/* ――――― FULLSCREEN ――――― */
.fullscreen {
    position: fixed !important;
    width: 100vw !important;
    height: 100vh !important;
    top: 0; left: 0;
    background: black !important;
    z-index: 99999 !important;
}

/* ――――― MOBILE + TABLET ――――― */
@media (max-width: 992px) {     /* Tablet */
    .main { flex-direction: column; }
    .left-panel { width: 100%; height: 55vh; }
    .right-panel { width: 100%; height: 45vh; }
}

@media (max-width: 600px) {     /* Mobile */
    .header { font-size: 12px; padding: 8px; gap: 10px; }
    .zoom-bar { bottom: 20px; gap: 12px; }
    .zoom-btn { font-size: 17px; }
}
/* CROP BOX BORDER WHITE */
.cropper-view-box {
    outline: 2px solid white !important;
}

/* INNER GRID LINES WHITE */
.cropper-dashed {
    border-color: white !important;
}

/* RESIZE HANDLES (corners) WHITE */
.cropper-line,
.cropper-point {
    background-color: white !important;
    border-color: white !important;
}
#patientTabs {
    background: #ffffff;
    border-bottom: 1px solid #d5ddea;
    padding: 5px 10px;
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    gap: 6px;
    height: 22px;
}


</style>
</head>

<body>

<!-- TABS -->
<div id="patientTabs">
    <div class="tab-item" onclick="goBack()">← PATIENT LIST</div>
    <!-- <div class="tab-item" onclick="showReports()">REPORTS</div> -->
</div>


<!-- HEADER -->
<div class="header">
    <span class="h-item">PAT. ID:</span> <span class="h-value">{{ patient.patient_id }}</span>
    <span class="h-item">NAME:</span> <span class="h-value">{{ patient.name }}</span>
    <span class="h-item">AGE/SEX:</span> <span class="h-value">{{ patient.age }}/{{ patient.gender }}</span>
    <span class="h-item">SCAN:</span> <span class="h-value">{{ patient.scan_type }}</span>
    <span class="h-item">BP:</span> <span class="h-value">{{ patient.body_part }}</span>
    <span class="h-item">HISTORY:</span> <span class="h-value">{{ patient.history }}</span>
</div>


<!-- MAIN -->
<div class="main">

    <!-- LEFT: PACS VIEWER -->
    <div class="left-panel" id="leftPanel">
        <img id="xrayImage" src="data:image/jpeg;base64,{{ patient.scan_image }}">
<!-- CROP CONFIRM OVERLAY -->
<div id="cropConfirm" 
     style="
        position:absolute; 
        bottom:80px; 
        left:50%; 
        transform:translateX(-50%);
        display:none; 
        gap: 220px;
        /* background:rgba(0,0,0,0.7);  */
        padding:10px 25px; 
        border-radius:10px;
        z-index:9999;
     ">
     <button id="cropCancel" style="padding:7px 16px; background:#dc3545; color:white; border:none; border-radius:6px; font-weight:600;">Cancel</button>

    <button id="cropOk" style="padding:7px 16px; background:#28a745; color:white; border:none; border-radius:6px; font-weight:600;">Done</button>
    </div>

        <div class="zoom-bar">
            <i class="fas fa-expand-arrows-alt zoom-btn" id="fullscreen"></i>
            <i class="fas fa-search-minus zoom-btn" id="zoomOut"></i>
            <i class="fas fa-search-plus zoom-btn" id="zoomIn"></i>
            <i class="fa-solid fa-rotate-right zoom-btn" id="reset"></i>
             
            
            <i style="color: white; cursor: pointer;" class="fas fa-expand zoom-btn"  id="cropBtn"></i>

        </div>
    </div>

    <!-- RIGHT: REPORT -->
    <div class="right-panel">
        <div class="report-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:8px 12px; background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border:1px solid #dee2e6; border-radius:10px 10px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <button onclick="newReport()" style="padding:6px 12px; background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition: all 0.3s ease;">+ New Report</button>
            <div id="savedReports" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
        </div>
        <div class="editor-box">
            <div id="editor" style="height: 400px;"></div>
        </div>

        <div class="btn-row">
            <button class="btn btn-draft" onclick="updateStatus('DRAFT')">DRAFT</button>
            <button class="btn btn-submit" onclick="updateStatus('FINAL')">SUBMIT</button>
        </div>
    </div>

</div>


<script>
var quill;
var reports = [];
var currentReportId = null;
var currentIndex = -1;
document.addEventListener('DOMContentLoaded', function() {
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'font': [] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'align': [] }],
                ['blockquote', 'code-block'],
                ['link', 'image'],
                ['clean']
            ]
        }
    });
    var initialContent = "{{ patient.report|default_if_none:"" |escapejs }}";
    quill.root.innerHTML = initialContent;
    loadReports();
});

// GLOBAL
let image = document.getElementById("xrayImage");
let cropper;
let cropMode = false;

// INIT CROPPER
function initCropper() {
    cropper = new Cropper(image, {
        viewMode: 1,
        dragMode: cropMode ? "crop" : "move",
        autoCrop: cropMode,
        autoCropArea: cropMode ? 1 : 0,  // ⭐ full crop area
        background: false,
        movable: !cropMode,
        scalable: false,
        zoomable: true,
        cropBoxMovable: true,
        cropBoxResizable: true
    });
}

initCropper();


// ⭐⭐⭐ CROP BUTTON CLICK
document.getElementById("cropBtn").onclick = () => {
    cropMode = true;

    cropper.destroy();
    initCropper();

    // FULL-SIZE CROP FRAME
    let box = cropper.getContainerData();
    cropper.setCropBoxData({
        left: 0,
        top: 0,
        width: box.width,
        height: box.height
    });

    // SHOW OK/CANCEL
    document.getElementById("cropConfirm").style.display = "flex";
};



// ❌ CANCEL CROP
document.getElementById("cropCancel").onclick = () => {
    cropMode = false;

    cropper.destroy();
    initCropper();

    // HIDE POPUP
    document.getElementById("cropConfirm").style.display = "none";
};



// ✔ OK → APPLY CROP + SAVE
document.getElementById("cropOk").onclick = () => {

    let canvas = cropper.getCroppedCanvas();

    if (!canvas) {
        alert("Please select a crop area");
        return;
    }

    let croppedImage = canvas.toDataURL("image/jpeg");

    // Show on screen
    image.src = croppedImage;

    // Save to backend
    fetch(`/api/patient/{{ patient.id }}/save-cropped-image/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ scan_image: croppedImage })
    });

    cropMode = false;

    cropper.destroy();
    initCropper();

    // HIDE POPUP
    document.getElementById("cropConfirm").style.display = "none";
};



// FULLSCREEN
document.getElementById("fullscreen").onclick = () => {
    const panel = document.getElementById("leftPanel");
    panel.classList.toggle("fullscreen");

    cropper.destroy();
    initCropper();
};



// ZOOM
document.getElementById("zoomIn").onclick = () => cropper.zoom(0.2);
document.getElementById("zoomOut").onclick = () => cropper.zoom(-0.2);
document.getElementById("reset").onclick = () => cropper.reset();


// SAVE REPORT
function updateStatus(status){
    if (!quill || !currentReportId) {
        alert('No report selected');
        return;
    }
    const report = quill.root.innerHTML;

    fetch(`/api/report/${currentReportId}/update/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
        body: JSON.stringify({ report_text: report, status })
    })
    .then(res => res.json())
    .then(data => {
        if(data.message === "Report updated"){
            alert("Updated Successfully");
            loadReports(); // Update list
            if(status === "FINAL") location.href = "/RADS/";
        }
    });
}

function getCookie(name){
    let cookieValue = null;
    if(document.cookie){
        const cookies = document.cookie.split(";");
        for(const c of cookies){
            const cookie = c.trim();
            if(cookie.startsWith(name + "=")){
                cookieValue = cookie.split("=")[1];
            }
        }
    }
    return cookieValue;
}


// ESC key → exit fullscreen
document.addEventListener("keydown", function (event) {
    const panel = document.getElementById("leftPanel");

    if (event.key === "Escape" && panel.classList.contains("fullscreen")) {
        panel.classList.remove("fullscreen");
        cropper.destroy();
        initCropper();
    }
});

// report sections
    function goBack() {
    const params = new URLSearchParams(window.location.search);
    const returnURL = params.get("return") || "/index/";
    window.location.href = returnURL;
}

function newReport() {
    fetch(`/api/patient/{{ patient.id }}/reports/create/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ report_text: '', status: 'DRAFT' })
    })
    .then(res => res.json())
    .then(data => {
        loadReports();
    });
}

function loadReports() {
    fetch(`/api/patient/{{ patient.id }}/reports/`)
    .then(res => res.json())
    .then(data => {
        reports = data.reports;
        updateSavedList();
        if (reports.length > 0) {
            loadReport(0);
        }
    });
}

function loadReport(index) {
    const report = reports[index];
    currentIndex = index;
    currentReportId = report.id;
    quill.root.innerHTML = report.report_text;
    updateSavedList();
}

function updateSavedList() {
    let list = document.getElementById('savedReports');
    list.innerHTML = '';
    reports.forEach((r, i) => {
        const isActive = i === currentIndex;
        const bgColor = isActive ? '#007bff' : 'white';
        const textColor = isActive ? 'white' : '#333';
        list.innerHTML += `
            <div style="position:relative; display:inline-block; margin-right:6px;">
                <button onclick="loadReport(${i})" class="report-btn${isActive ? ' active' : ''}" style="padding:6px 12px; background:${bgColor}; color:${textColor}; border-radius:4px; font-size:12px; cursor:pointer; transition: all 0.3s ease;">
                    Report ${i+1} (${r.status === 'DRAFT' ? 'D' : 'F'})
                    <i onclick="event.stopPropagation(); toggleMenu(${i})" style="margin-left:4px; font-style:normal;">&#8942;</i>
                </button>
                <div id="menu-${i}" style="display:none; position:absolute; top:100%; left:0; background:white; border:1px solid #ccc; z-index:10; border-radius:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <button onclick="deleteReport(${i})" style="display:block; width:100%; padding:8px; border:none; background:none; cursor:pointer; text-align:left;">Delete</button>
                </div>
            </div>
        `;
    });
}

function toggleMenu(index) {
    const menu = document.getElementById('menu-' + index);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function deleteReport(index) {
    if (confirm('Delete this report?')) {
        fetch(`/api/report/${reports[index].id}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(() => loadReports());
    }
}
</script>

</body>
</html>
