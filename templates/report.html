<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Report</title>

<!-- LIB FILES -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;600;700&family=Poppins:wght@300;400;600;700&family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>

:root {
    --blue: #1a7bff;
    --light-bg: #f4f7fb;
    --text-dark: #2a2a2a;
}

/* GLOBAL */
body {
    margin: 0;
    background: black;
    font-family: "Segoe UI", Arial;
    overflow: hidden;
}

/* ――――― TOP HEADER ――――― */
.header {
    background: #ffffff;
    padding: 10px 15px;
    margin-top: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    border-bottom: 1px solid #d5e1ef;
    font-size: 14px;
}

.h-item { color: #3b3b3b; font-weight: 600; }
.h-value { color: var(--blue); font-weight: 700; }

/* ――――― TABS ――――― */
#patientTabs {
    background: #ffffff;
    border-bottom: 1px solid #d5ddea;
    padding: 5px 10px;
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    gap: 6px;
    z-index: 5000;
    height: 22px;
}

.tab-item {
    padding: 3px 10px;
    font-size: 12px;
    background: #eaf1ff;
    border-radius: 4px;
    border: 1px solid #c7d8f5;
    cursor: pointer;
}

.tab-active {
    background: var(--blue);
    color: white;
    border-color: #1055b6;
}

/* ――――― MAIN LAYOUT ――――― */
.main {
    display: flex;
    height: calc(100vh - 82px);
    width: 100%;
}

/* LEFT PANEL - PACS VIEWER */
.left-panel {
    width: 50%;
    background: black !important;
    display: flex;
    position: relative;
}

/* SIDEBAR FOR THUMBNAILS */
.image-sidebar {
    width: 60px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px 5px;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-right: 2px solid #333;
}

/* Sidebar scrollbar styling */
.image-sidebar::-webkit-scrollbar {
    width: 6px;
}

.image-sidebar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
}

.image-sidebar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.image-sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* MAIN IMAGE CONTAINER */
.image-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
}

#xrayImage {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    background: black !important;
    display: block;
}

/* Fix cropper BG always black */
.cropper-container,
.cropper-wrap-box,
.cropper-canvas,
.cropper-view-box {
    background-color: black !important;
}

/* ――――― ZOOM BAR ――――― */
.zoom-bar {
    position: absolute;
    bottom: 15px;
    display: flex;
    gap: 14px;
    padding: 10px 20px;
    background: rgba(0,0,0,0.55);
    border-radius: 40px;
    backdrop-filter: blur(4px);
}

.zoom-btn {
    font-size: 18px;
    color: white;
    cursor: pointer;
    transition: 0.2s;
}
.zoom-btn:hover {
    color: var(--blue);
    transform: scale(1.2);
}

/* ――――― RIGHT PANEL ――――― */
.right-panel {
    width: 50%;
    background: var(--light-bg);
    padding: 15px;
    overflow-y: auto;
}

.editor-box {
    background: white;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #e1e6f0;
}

/* MS Word-like Quill styles */
.ql-toolbar {
    border: 1px solid #ccc;
    border-bottom: none;
    background: #f8f8f8;
    border-radius: 10px 10px 0 0;
}
.ql-container {
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 10px 10px;
}
.ql-editor {
    font-family: 'Calibri', sans-serif;
    font-size: 11pt;
    line-height: 1.15;
    padding: 12px 15px;
    min-height: 400px;
}

/* Custom Font Families */
.ql-font-arial {
    font-family: Arial, sans-serif;
}

.ql-font-calibri {
    font-family: 'Calibri', sans-serif;
}

.ql-font-times-new-roman {
    font-family: 'Times New Roman', serif;
}

.ql-font-courier-new {
    font-family: 'Courier New', monospace;
}

.ql-font-georgia {
    font-family: Georgia, serif;
}

.ql-font-verdana {
    font-family: Verdana, sans-serif;
}

.ql-font-tahoma {
    font-family: Tahoma, sans-serif;
}

.ql-font-comic-sans {
    font-family: 'Comic Sans MS', cursive;
}

.ql-font-impact {
    font-family: Impact, fantasy;
}

.ql-font-helvetica {
    font-family: Helvetica, Arial, sans-serif;
}

.ql-font-garamond {
    font-family: Garamond, serif;
}

.ql-font-trebuchet {
    font-family: 'Trebuchet MS', sans-serif;
}

.ql-font-palatino {
    font-family: Palatino, serif;
}

.ql-font-roboto {
    font-family: 'Roboto', sans-serif;
}

.ql-font-open-sans {
    font-family: 'Open Sans', sans-serif;
}

.ql-font-lato {
    font-family: 'Lato', sans-serif;
}

.ql-font-montserrat {
    font-family: 'Montserrat', sans-serif;
}

.ql-font-poppins {
    font-family: 'Poppins', sans-serif;
}

.ql-font-ubuntu {
    font-family: 'Ubuntu', sans-serif;
}

/* Improve font dropdown display */
.ql-picker-label[data-label]::before,
.ql-picker-item[data-label]::before {
    content: attr(data-label);
}

/* Font dropdown styling */
.ql-picker.ql-font .ql-picker-label[data-value="arial"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="arial"]::before {
    content: 'Arial';
    font-family: Arial, sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="calibri"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="calibri"]::before {
    content: 'Calibri';
    font-family: 'Calibri', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="times-new-roman"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="times-new-roman"]::before {
    content: 'Times New Roman';
    font-family: 'Times New Roman', serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="courier-new"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="courier-new"]::before {
    content: 'Courier New';
    font-family: 'Courier New', monospace;
}

.ql-picker.ql-font .ql-picker-label[data-value="georgia"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="georgia"]::before {
    content: 'Georgia';
    font-family: Georgia, serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="verdana"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="verdana"]::before {
    content: 'Verdana';
    font-family: Verdana, sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="tahoma"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="tahoma"]::before {
    content: 'Tahoma';
    font-family: Tahoma, sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="comic-sans"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="comic-sans"]::before {
    content: 'Comic Sans MS';
    font-family: 'Comic Sans MS', cursive;
}

.ql-picker.ql-font .ql-picker-label[data-value="impact"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="impact"]::before {
    content: 'Impact';
    font-family: Impact, fantasy;
}

.ql-picker.ql-font .ql-picker-label[data-value="helvetica"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="helvetica"]::before {
    content: 'Helvetica';
    font-family: Helvetica, Arial, sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="garamond"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="garamond"]::before {
    content: 'Garamond';
    font-family: Garamond, serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="trebuchet"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="trebuchet"]::before {
    content: 'Trebuchet MS';
    font-family: 'Trebuchet MS', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="palatino"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="palatino"]::before {
    content: 'Palatino';
    font-family: Palatino, serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="roboto"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="roboto"]::before {
    content: 'Roboto';
    font-family: 'Roboto', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="open-sans"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="open-sans"]::before {
    content: 'Open Sans';
    font-family: 'Open Sans', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="lato"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="lato"]::before {
    content: 'Lato';
    font-family: 'Lato', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="montserrat"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="montserrat"]::before {
    content: 'Montserrat';
    font-family: 'Montserrat', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="poppins"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="poppins"]::before {
    content: 'Poppins';
    font-family: 'Poppins', sans-serif;
}

.ql-picker.ql-font .ql-picker-label[data-value="ubuntu"]::before,
.ql-picker.ql-font .ql-picker-item[data-value="ubuntu"]::before {
    content: 'Ubuntu';
    font-family: 'Ubuntu', sans-serif;
}

/* Report buttons */
.report-btn {
    background: white;
    color: #333;
    border: 1px solid #ccc;
    transition: all 0.3s ease;
}
.report-btn.active {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

/* BUTTONS */
.btn-row {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
}

.btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

.btn-draft {
    background: #ffe9b8;
    color: #745200;
}

.btn-submit {
    background: #28a745;
    color: white;
}

/* ――――― FULLSCREEN ――――― */
.fullscreen {
    position: fixed !important;
    width: 100vw !important;
    height: 100vh !important;
    top: 0; left: 0;
    background: black !important;
    z-index: 99999 !important;
}

.fullscreen .image-sidebar {
    display: none !important;
}

.fullscreen .image-container {
    width: 100% !important;
}

/* ――――― MOBILE + TABLET ――――― */
@media (max-width: 992px) {     /* Tablet */
    .main { flex-direction: column; }
    .left-panel { width: 100%; height: 55vh; flex-direction: row; }
    .image-sidebar { width: 50px; padding: 8px 4px; }
    .right-panel { width: 100%; height: 45vh; }
}

@media (max-width: 600px) {     /* Mobile */
    .header { font-size: 12px; padding: 8px; gap: 10px; }
    .zoom-bar { bottom: 20px; gap: 12px; }
    .zoom-btn { font-size: 17px; }
    .image-sidebar { width: 40px; padding: 6px 3px; gap: 6px; }
}
/* CROP BOX BORDER WHITE */
.cropper-view-box {
    outline: 2px solid white !important;
}

/* INNER GRID LINES WHITE */
.cropper-dashed {
    border-color: white !important;
}

/* RESIZE HANDLES (corners) WHITE */
.cropper-line,
.cropper-point {
    background-color: white !important;
    border-color: white !important;
}
#patientTabs {
    background: #ffffff;
    border-bottom: 1px solid #d5ddea;
    padding: 5px 10px;
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    gap: 6px;
    height: 22px;
}


</style>
</head>

<body>

<!-- TABS -->
<div id="patientTabs">
    <div class="tab-item" onclick="goBack()">← PATIENT LIST</div>
    <!-- <div class="tab-item" onclick="showReports()">REPORTS</div> -->
</div>


<!-- HEADER -->
<div class="header">
    <span class="h-item">PAT. ID:</span> <span class="h-value">{{ patient.patient_id }}</span>
    <span class="h-item">NAME:</span> <span class="h-value">{{ patient.name }}</span>
    <span class="h-item">AGE/SEX:</span> <span class="h-value">{{ patient.age }}/{{ patient.gender }}</span>
    <span class="h-item">SCAN:</span> <span class="h-value">{{ patient.scan_type }}</span>
    <span class="h-item">BP:</span> <span class="h-value">{{ patient.body_part }}</span>
    <span class="h-item">HISTORY:</span> <span class="h-value">{{ patient.history }}</span>
</div>


<!-- MAIN -->
<div class="main">

    <!-- LEFT: PACS VIEWER -->
    <div class="left-panel" id="leftPanel">
        <!-- SIDEBAR FOR THUMBNAILS -->
        <div class="image-sidebar" id="thumbnailGallery">
            <!-- Thumbnails will be inserted here -->
        </div>

        <!-- MAIN IMAGE CONTAINER -->
        <div class="image-container">
            <img id="xrayImage" src="data:image/jpeg;base64,{{ patient.scan_image }}">
            
            <!-- CROP CONFIRM OVERLAY -->
            <div id="cropConfirm" 
                 style="
                    position:absolute; 
                    bottom:80px; 
                    left:50%; 
                    transform:translateX(-50%);
                    display:none; 
                    gap: 220px;
                    padding:10px 25px; 
                    border-radius:10px;
                    z-index:9999;
                 ">
                 <button id="cropCancel" style="padding:7px 16px; background:#dc3545; color:white; border:none; border-radius:6px; font-weight:600;">Cancel</button>
                <button id="cropOk" style="padding:7px 16px; background:#28a745; color:white; border:none; border-radius:6px; font-weight:600;">Done</button>
            </div>

            <div class="zoom-bar">
                <i class="fas fa-expand-arrows-alt zoom-btn" id="fullscreen"></i>
                <i class="fas fa-search-minus zoom-btn" id="zoomOut"></i>
                <i class="fas fa-search-plus zoom-btn" id="zoomIn"></i>
                <i class="fa-solid fa-rotate-right zoom-btn" id="reset"></i>
                <i style="color: white; cursor: pointer;" class="fas fa-expand zoom-btn"  id="cropBtn"></i>
            </div>
        </div>
    </div>

    <!-- RIGHT: REPORT -->
    <div class="right-panel">
        <div class="report-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:8px 12px; background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border:1px solid #dee2e6; border-radius:10px 10px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <button onclick="newReport()" style="padding:6px 12px; background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition: all 0.3s ease;">+ New Report</button>
            <div id="savedReports" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
        </div>
        <div class="editor-box">
            <div id="editor" style="height: 400px;"></div>
        </div>

        <div class="btn-row">
            <button class="btn btn-draft" onclick="updateStatus('DRAFT')">DRAFT</button>
            <button class="btn btn-submit" onclick="updateStatus('FINAL')">SUBMIT</button>
        </div>
    </div>

</div>


<script>
var quill;
var reports = [];
var currentReportId = null;
var currentIndex = -1;
// Multiple images support
let patientImages = [];
let currentImageIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Define custom font families with proper display names
    var Font = Quill.import('formats/font');
    Font.whitelist = [
        'arial', 'calibri', 'times-new-roman', 'courier-new', 
        'georgia', 'verdana', 'tahoma', 'comic-sans', 'impact',
        'helvetica', 'garamond', 'trebuchet', 'palatino', 'roboto',
        'open-sans', 'lato', 'montserrat', 'poppins', 'ubuntu'
    ];
    Quill.register(Font, true);
    
    // Define custom font sizes with readable labels
    var Size = Quill.import('formats/size');
    Size.whitelist = ['8px', '9px', '10px', '11px', '12px', '14px', '16px', '18px', '20px', '24px', '28px', '32px', '36px', '48px', '72px'];
    Quill.register(Size, true);
    
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{ 'font': ['arial', 'calibri', 'times-new-roman', 'courier-new', 'georgia', 'verdana', 'tahoma', 'comic-sans', 'impact', 'helvetica', 'garamond', 'trebuchet', 'palatino', 'roboto', 'open-sans', 'lato', 'montserrat', 'poppins', 'ubuntu'] }],
                    [{ 'size': ['8px', '9px', '10px', '11px', '12px', '14px', '16px', '18px', '20px', '24px', '28px', '32px', '36px', '48px', '72px'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image'],
                    ['clean']
                ],
                handlers: {
                    'font': function(value) {
                        if (value) {
                            this.quill.format('font', value);
                        } else {
                            this.quill.format('font', false);
                        }
                    }
                }
            }
        }
    });
    
    // Customize font dropdown labels with proper names
    function updateFontLabels() {
        var fontPicker = document.querySelector('.ql-picker.ql-font');
        if (fontPicker) {
            var fontItems = fontPicker.querySelectorAll('.ql-picker-item');
            var fontLabel = fontPicker.querySelector('.ql-picker-label');
            
            var fontLabels = {
                'arial': 'Arial',
                'calibri': 'Calibri',
                'times-new-roman': 'Times New Roman',
                'courier-new': 'Courier New',
                'georgia': 'Georgia',
                'verdana': 'Verdana',
                'tahoma': 'Tahoma',
                'comic-sans': 'Comic Sans MS',
                'impact': 'Impact',
                'helvetica': 'Helvetica',
                'garamond': 'Garamond',
                'trebuchet': 'Trebuchet MS',
                'palatino': 'Palatino',
                'roboto': 'Roboto',
                'open-sans': 'Open Sans',
                'lato': 'Lato',
                'montserrat': 'Montserrat',
                'poppins': 'Poppins',
                'ubuntu': 'Ubuntu'
            };
            
            fontItems.forEach(function(item) {
                var value = item.getAttribute('data-value');
                if (value && fontLabels[value]) {
                    item.textContent = fontLabels[value];
                    item.style.fontFamily = fontLabels[value] + ', sans-serif';
                }
            });
            
            // Update label when font is selected
            if (fontLabel) {
                var currentValue = fontLabel.getAttribute('data-value');
                if (currentValue && fontLabels[currentValue]) {
                    fontLabel.textContent = fontLabels[currentValue];
                }
            }
        }
        
        // Customize size dropdown labels
        var sizePicker = document.querySelector('.ql-picker.ql-size');
        if (sizePicker) {
            var sizeItems = sizePicker.querySelectorAll('.ql-picker-item');
            sizeItems.forEach(function(item) {
                var value = item.getAttribute('data-value');
                if (value) {
                    item.textContent = value.toUpperCase();
                }
            });
        }
    }
    
    // Update labels after Quill initializes
    setTimeout(updateFontLabels, 200);
    
    // Update labels when dropdown opens
    document.addEventListener('click', function(e) {
        if (e.target.closest('.ql-picker.ql-font') || e.target.closest('.ql-picker.ql-size')) {
            setTimeout(updateFontLabels, 50);
        }
    });
    
    // Watch for font changes
    quill.on('selection-change', function() {
        setTimeout(updateFontLabels, 50);
    });
    var initialContent = "{{ patient.report|default_if_none:"" |escapejs }}";
    quill.root.innerHTML = initialContent;
    loadReports();
    
    // Load images from patient data
    try {
        const scanData = "{{ patient.scan_image|escapejs }}";
        // Try to parse as JSON (multiple images)
        try {
            patientImages = JSON.parse(scanData);
            if (!Array.isArray(patientImages)) {
                // If not array, make it array
                patientImages = [patientImages];
            }
        } catch(e) {
            // Single image (backward compatibility)
            if (scanData) {
                patientImages = [scanData];
            } else {
                patientImages = [];
            }
        }
    } catch(e) {
        patientImages = [];
    }

    // Render thumbnail gallery
    renderThumbnails();
    
    // Load first image
    if (patientImages.length > 0) {
        loadImage(0);
    }
});

// GLOBAL
let image = document.getElementById("xrayImage");
let cropper;
let cropMode = false;

// INIT CROPPER
function initCropper() {
    const image = document.getElementById("xrayImage");
    // Wait for image to load
    if (image.complete) {
        if (cropper) cropper.destroy();
        cropper = new Cropper(image, {
            viewMode: 1,
            dragMode: cropMode ? "crop" : "move",
            autoCrop: cropMode,
            autoCropArea: cropMode ? 1 : 0,  // ⭐ full crop area
            background: false,
            movable: !cropMode,
            scalable: false,
            zoomable: true,
            cropBoxMovable: true,
            cropBoxResizable: true
        });
    } else {
        image.onload = function() {
            if (cropper) cropper.destroy();
            cropper = new Cropper(image, {
                viewMode: 1,
                dragMode: cropMode ? "crop" : "move",
                autoCrop: cropMode,
                autoCropArea: cropMode ? 1 : 0,
                background: false,
                movable: !cropMode,
                scalable: false,
                zoomable: true,
                cropBoxMovable: true,
                cropBoxResizable: true
            });
        };
    }
}

// Thumbnail gallery functions
function renderThumbnails() {
    const gallery = document.getElementById("thumbnailGallery");
    if (!gallery) return;
    
    gallery.innerHTML = "";
    
    if (patientImages.length === 0) {
        gallery.style.display = "none";
        return;
    }
    
    gallery.style.display = "flex";
    
    patientImages.forEach((img, index) => {
        const thumb = document.createElement("div");
        thumb.style.cssText = `
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid ${index === currentImageIndex ? '#007bff' : '#555'};
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            background: #000;
            transition: all 0.3s;
            position: relative;
            box-shadow: ${index === currentImageIndex ? '0 0 8px rgba(0,123,255,0.5)' : 'none'};
        `;
        thumb.onmouseover = () => {
            if (index !== currentImageIndex) {
                thumb.style.transform = "scale(1.05)";
                thumb.style.borderColor = "#888";
            }
        };
        thumb.onmouseout = () => {
            if (index !== currentImageIndex) {
                thumb.style.transform = "scale(1)";
                thumb.style.borderColor = "#555";
            }
        };
        
        const imgEl = document.createElement("img");
        imgEl.src = `data:image/jpeg;base64,${img}`;
        imgEl.style.cssText = "width:100%; height:100%; object-fit:contain;";
        imgEl.onerror = function() {
            this.src = "data:image/jpeg;base64," + img;
        };
        
        // Image number badge
        const badge = document.createElement("div");
        badge.style.cssText = `
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,123,255,0.9);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            z-index: 10;
        `;
        badge.textContent = index + 1;
        thumb.appendChild(badge);
        
        thumb.onclick = () => loadImage(index);
        thumb.appendChild(imgEl);
        gallery.appendChild(thumb);
    });
}

function loadImage(index) {
    if (index < 0 || index >= patientImages.length) return;
    
    currentImageIndex = index;
    const image = document.getElementById("xrayImage");
    
    // Update image source
    image.src = `data:image/jpeg;base64,${patientImages[index]}`;
    
    // Update cropper when image loads
    image.onload = function() {
        if (cropper) {
            cropper.destroy();
        }
        initCropper();
    };
    
    // If image already loaded
    if (image.complete) {
        image.onload();
    }
    
    // Update thumbnail borders
    renderThumbnails();
}

// Initialize cropper after page load
setTimeout(() => {
    if (patientImages.length > 0) {
        initCropper();
    }
}, 500);


// ⭐⭐⭐ CROP BUTTON CLICK
document.getElementById("cropBtn").onclick = () => {
    cropMode = true;

    cropper.destroy();
    initCropper();

    // FULL-SIZE CROP FRAME
    let box = cropper.getContainerData();
    cropper.setCropBoxData({
        left: 0,
        top: 0,
        width: box.width,
        height: box.height
    });

    // SHOW OK/CANCEL
    document.getElementById("cropConfirm").style.display = "flex";
};



// ❌ CANCEL CROP
document.getElementById("cropCancel").onclick = () => {
    cropMode = false;

    cropper.destroy();
    initCropper();

    // HIDE POPUP
    document.getElementById("cropConfirm").style.display = "none";
};



// ✔ OK → APPLY CROP + SAVE
document.getElementById("cropOk").onclick = () => {

    let canvas = cropper.getCroppedCanvas();

    if (!canvas) {
        alert("Please select a crop area");
        return;
    }

    let croppedImage = canvas.toDataURL("image/jpeg");

    // Show on screen
    image.src = croppedImage;
    
    // Update in patientImages array
    if (currentImageIndex < patientImages.length) {
        // Remove data:image prefix if present
        let imgData = croppedImage;
        if (imgData.includes(',')) {
            imgData = imgData.split(',')[1];
        }
        patientImages[currentImageIndex] = imgData;
    }

    // Save to backend
    fetch(`/api/patient/{{ patient.id }}/save-cropped-image/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ 
            scan_image: croppedImage,
            image_index: currentImageIndex 
        })
    })
    .then(() => {
        // Update thumbnail
        renderThumbnails();
    });

    cropMode = false;

    cropper.destroy();
    initCropper();

    // HIDE POPUP
    document.getElementById("cropConfirm").style.display = "none";
};



// FULLSCREEN
function toggleFullscreen() {
    const panel = document.getElementById("leftPanel");
    panel.classList.toggle("fullscreen");
    if (cropper) {
        cropper.destroy();
        initCropper();
    }
}

document.getElementById("fullscreen").onclick = () => {
    toggleFullscreen();
};



// ZOOM
document.getElementById("zoomIn").onclick = () => cropper.zoom(0.2);
document.getElementById("zoomOut").onclick = () => cropper.zoom(-0.2);
document.getElementById("reset").onclick = () => cropper.reset();


// SAVE REPORT
function updateStatus(status){
    if (!quill) {
        alert('Editor not initialized');
        return;
    }
    
    // If no report selected, create a new one first
    if (!currentReportId) {
        // Create new report first
        fetch(`/api/patient/{{ patient.id }}/reports/create/`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ 
                report_text: quill.root.innerHTML, 
                status: status 
            })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error('Failed to create report');
            }
            return res.json();
        })
        .then(data => {
            if (status === "FINAL") {
                alert("Report submitted successfully!");
                location.href = "/RADS/";
            } else {
                alert("Draft saved successfully!");
                loadReports();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
        return;
    }
    
    const report = quill.root.innerHTML;

    fetch(`/api/report/${currentReportId}/update/`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json", 
            "X-CSRFToken": getCookie("csrftoken") 
        },
        body: JSON.stringify({ report_text: report, status })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Failed to update report');
        }
        return res.json();
    })
    .then(data => {
        if(data.message === "Report updated" || data.status === "success"){
            if(status === "FINAL") {
                alert("Report submitted successfully!");
                location.href = "/RADS/";
            } else {
                alert("Draft saved successfully!");
                loadReports(); // Update list
            }
        } else {
            alert("Response: " + (data.message || "Unknown response"));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting report: ' + error.message);
    });
}

function getCookie(name){
    let cookieValue = null;
    if(document.cookie){
        const cookies = document.cookie.split(";");
        for(const c of cookies){
            const cookie = c.trim();
            if(cookie.startsWith(name + "=")){
                cookieValue = cookie.split("=")[1];
            }
        }
    }
    return cookieValue;
}


// ESC key → exit fullscreen
document.addEventListener("keydown", function (event) {
    const panel = document.getElementById("leftPanel");

    if (event.key === "Escape" && panel.classList.contains("fullscreen")) {
        panel.classList.remove("fullscreen");
        cropper.destroy();
        initCropper();
    }
});

// report sections
    function goBack() {
    const params = new URLSearchParams(window.location.search);
    const returnURL = params.get("return") || "/index/";
    window.location.href = returnURL;
}

function newReport() {
    fetch(`/api/patient/{{ patient.id }}/reports/create/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ report_text: quill ? quill.root.innerHTML : '', status: 'DRAFT' })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Failed to create report');
        }
        return res.json();
    })
    .then(data => {
        loadReports();
    })
    .catch(error => {
        console.error('Error creating report:', error);
        alert('Error creating report: ' + error.message);
    });
}

function loadReports() {
    fetch(`/api/patient/{{ patient.id }}/reports/`)
    .then(res => {
        if (!res.ok) {
            throw new Error('Failed to load reports');
        }
        return res.json();
    })
    .then(data => {
        reports = data.reports || [];
        updateSavedList();
        if (reports.length > 0) {
            loadReport(0);
        } else {
            // No reports exist, reset currentReportId
            currentReportId = null;
            currentIndex = -1;
        }
    })
    .catch(error => {
        console.error('Error loading reports:', error);
        reports = [];
        currentReportId = null;
        currentIndex = -1;
        updateSavedList();
    });
}

function loadReport(index) {
    const report = reports[index];
    currentIndex = index;
    currentReportId = report.id;
    quill.root.innerHTML = report.report_text;
    updateSavedList();
}

function updateSavedList() {
    let list = document.getElementById('savedReports');
    list.innerHTML = '';
    reports.forEach((r, i) => {
        const isActive = i === currentIndex;
        const bgColor = isActive ? '#007bff' : 'white';
        const textColor = isActive ? 'white' : '#333';
        list.innerHTML += `
            <div style="position:relative; display:inline-block; margin-right:6px;">
                <button onclick="loadReport(${i})" class="report-btn${isActive ? ' active' : ''}" style="padding:6px 12px; background:${bgColor}; color:${textColor}; border-radius:4px; font-size:12px; cursor:pointer; transition: all 0.3s ease;">
                    Report ${i+1} (${r.status === 'DRAFT' ? 'D' : 'F'})
                    <i onclick="event.stopPropagation(); toggleMenu(${i})" style="margin-left:4px; font-style:normal;">&#8942;</i>
                </button>
                <div id="menu-${i}" style="display:none; position:absolute; top:100%; left:0; background:white; border:1px solid #ccc; z-index:10; border-radius:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <button onclick="deleteReport(${i})" style="display:block; width:100%; padding:8px; border:none; background:none; cursor:pointer; text-align:left;">Delete</button>
                </div>
            </div>
        `;
    });
}

function toggleMenu(index) {
    const menu = document.getElementById('menu-' + index);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function deleteReport(index) {
    if (confirm('Delete this report?')) {
        fetch(`/api/report/${reports[index].id}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(() => loadReports());
    }
}
</script>

</body>
</html>
